/*! meitovexflow 2014-06-30 */
var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a,this.message=b},MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""},MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)},MeiLib.EventEnumerator=function(a,b){this.init(a,b)},MeiLib.EventEnumerator.prototype.init=function(a,b){if(!a)throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");this.node=a,this.next_evnt=null,this.EoI=!0,this.children=$(this.node).children(),this.i_next=-1,this.proportion=b||{num:1,numbase:1},this.outputProportion=b||{num:1,numbase:1},this.read_ahead()},MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;return this.read_ahead(),a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")},MeiLib.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()},MeiLib.EventEnumerator.prototype.step_ahead=function(){if(++this.i_next,this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");if("note"===a||"rest"===a||"mRest"===a||"chord"===a)this.EoI=!1;else if("beam"===a)this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1);else if("tuplet"===a){var b={num:this.proportion.num*+this.next_evnt.getAttribute("num")||3,numbase:this.proportion.numbase*+this.next_evnt.getAttribute("numbase")||2};this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt,b),this.beam_enumerator.EoI?(this.outputProportion=this.proportion,this.EoI=!0):(this.outputProportion=this.beam_enumerator.outputProportion,this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1)}}else this.EoI=!0},MeiLib.durationOf=function(a,b){IsSimpleEvent=function(a){return"note"===a||"rest"===a||"space"===a};var c=function(a,b){var c=$(a).attr("dur");if(!c)throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <b>note</b>, <b>rest</b> or <b>space</b> must be specified.");return MeiLib.dotsMult(a)*MeiLib.dur2beats(Number(c),b)},d=function(a,b,c){c||(c="1");var d=$(a).attr("dur"),e=MeiLib.dotsMult(a);if(d)return e*MeiLib.dur2beats(Number(d),b);if($(a).find("note").each(function(){if(lyr_n=$(this).attr("layer"),!lyr_n||lyr_n===c){var b=$(this).attr("dur"),f=MeiLib.dotsMult(a);if(!d&&b)d=b,e=f;else if(d&&d!=b)throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}),d)return e*MeiLib.dur2beats(Number(d),b);throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")},e=function(a,b){var g=0;return $(a).children().each(function(){var a,h=this.localName;if(IsSimpleEvent(h))a=c(this,b);else if("chord"===h)a=d(this,b);else if("beam"===h)a=e(this,b);else{if("tuplet"!==h)throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+h+"'");a=f(this,b)}g+=a}),g},f=function(a,b){var c=+a.getAttribute("num")||3,d=+a.getAttribute("numbase")||2,f=e(a,{count:b.count,unit:b.unit*d/c});return f},g=$(a).prop("localName");if(IsSimpleEvent(g))return c(a,b);if("mRest"===g)return b.count;if("chord"===g)return d(a,b);if("beam"===g)return e(a,b);if("tuplet"===g)return f(a,b);throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+g+"'")},MeiLib.tstamp2id=function(a,b,c){for(var d,f,g,h,i=Number(a),j=0,k=function(){return j+1},l=function(){return i-k()},n=new MeiLib.EventEnumerator(b);!n.EoI&&(void 0===f||f>0);)g=d,h=f,d=n.nextEvent(),f=l(),j+=MeiLib.durationOf(d,c)*n.outputProportion.numbase/n.outputProportion.num,m=c,e=d;if(void 0===f)return void 0;var o;o=0>f&&g&&h<Math.abs(f)?g:d;var p;return p=$(o).attr("xml:id"),p||(p=MeiLib.createPseudoUUID(),$(o).attr("xml:id",p)),p},MeiLib.XMLID=function(a){return xml_id=$(a).attr("xml:id"),xml_id||(xml_id=MeiLib.createPseudoUUID(),$(a).attr("xml:id",xml_id)),xml_id},MeiLib.id2tstamp=function(a,b){for(var c,d=!1,e=0;e<b.length&&!d;++e){if(b[e].meter&&(c=b[e].meter),0===e&&!c)throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var f=MeiLib.sumUpUntil(a,b[e].layer,c);if(f.found)return d=!0,e.toString()+"m+"+(f.beats+1).toString()}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+a+'" was found in the given MEI context.')},MeiLib.dur2beats=function(a,b){return b.unit/a},MeiLib.beats2dur=function(a,b){return b.unit/a},MeiLib.dotsMult=function(a){var b=$(a).attr("dots");b=Number(b||"0");for(var c=1;b>0;--b)c+=1/Math.pow(2,b);return c},MeiLib.sumUpUntil=function(a,b,c){var d=function(b){var e,f,g,h,i,j,k,l,m=$(b),n=m.prop("localName");if("note"===n||"rest"===n){if(m.attr("xml:id")===a)return{beats:0,found:!0};if(h=Number(m.attr("dur")),!h)throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");return i=m.attr("dots"),i=Number(i||"0"),e=MeiLib.dotsMult(m)*MeiLib.dur2beats(h,c),{beats:e,found:!1}}if("mRest"===n)return m.attr("xml:id")===a?(g=!0,{beats:0,found:!0}):{beats:c.count,found:!1};if("layer"===n||"beam"===n||"tuplet"===n){for(e=0,f=m.children(),g=!1,l=0;l<f.length&&!g;++l)j=d(f[l]),e+=j.beats,g=j.found;return{beats:e,found:g}}if("chord"===n){if(k=m.attr("dur"),m.attr("xml:id")===a)return{beats:0,found:!0};if(k=m.attr("dur"))return m.find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:MeiLib.dur2beats(k,c),found:g};for(f=m.children(),g=!1,l=0;l<f.length&&!g;++l)j=d(f[l]),e=j.beats,g=j.found;return{beats:e,found:g}}return{beats:0,found:!1}};return d(b)},MeiLib.SliceMEI=function(a,b){var c=function(a,b){$.each(a,function(a,c){b.noClef&&$(c).attr("clef.visible","false"),b.noKey&&$(c).attr("key.sig.show","false"),b.noMeter&&$(c).attr("meter.rend","false")})},d=b.staves;if(d)for(var e="",f="",g="",h=0;h<d.length;h++)e+=g+'[n="'+d[h]+'"]',f+=g+'[staff="'+d[h]+'"]',0===h&&(g=", ");var i,j=a.cloneNode(!0);if(d&&$(j).find("staffDef").remove(":not("+e+")"),b.noClef||b.noKey||b.noMeter){var k=$(j).find("staffDef");i=$(j).find("scoreDef"),c(i,b),c(k,b)}b.noConnectors&&$(j).find("staffGrp").removeAttr("symbol");var l=$(j).find("section")[0],m=!1,n=!1,o=l.childNodes;return $(o).each(function(){var a=this;if(m||("measure"===a.localName&&Number($(a).attr("n"))===b.start_n?(m=!0,n=!0):l.removeChild(a)),m){if(d){$(a).find("[staff]").remove(":not("+f+")");var c=$(a).find("staff");$(c).each(function(){var a=this;if(-1===$.inArray(Number($(a).attr("n")),d)){var b=this.parentNode;b.removeChild(this)}})}"measure"===a.localName&&Number($(a).attr("n"))===b.end_n&&(m=!1)}}),j},MeiLib.Alt=function(a,b,c,d){this.elem=a,this.xmlID=b,this.altitems=[],this.parentID=c,this.tagname=d},MeiLib.Alt.prototype.getDefaultItem=function(){var a=function(a,b,c){var d;for(alt in a){if(a[alt].tagname===b)return a[alt];d||a[alt].tagname!==c||(d=a[alt])}return d};return"choice"===this.tagname?a(this.altitems,"corr","sic"):"app"===this.tagname?a(this.altitems,"lem"):void 0},MeiLib.Variant=function(a,b,c,d,e,f){this.elem=a,this.xmlID=b,this.tagname=c,this.source=d,this.resp=e,this.n=f},MeiLib.MeiDoc=function(a){a&&this.init(a)},MeiLib.MeiDoc.prototype.init=function(a){this.xmlDoc=a,this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0],this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0],this.rich_score=$(this.rich_music).find("score")[0],this.parseSourceList(),this.parseEditorList(),this.parseALTs(),this.initAltgroups(),this.initSectionView()},MeiLib.MeiDoc.prototype.getRichScore=function(){return this.rich_score},MeiLib.MeiDoc.prototype.getPlainScore=function(){return this.plain_score},MeiLib.MeiDoc.prototype.getALTs=function(){return this.ALTs},MeiLib.MeiDoc.prototype.getSourceList=function(){return this.sourceList},MeiLib.MeiDoc.prototype.getEditorList=function(){return this.editorList},MeiLib.MeiDoc.prototype.parseSourceList=function(){return this.sources=$(this.rich_head).find("sourceDesc").children(),this.sources},MeiLib.MeiDoc.prototype.parseEditorList=function(){return this.editors=$(this.rich_head).find("titleStmt").children("editor"),this.editors},MeiLib.MeiDoc.prototype.parseALTs=function(){var a,b;this.ALTs={};var c=$(this.rich_score).find("app, choice");for(a=0;a<c.length;a++){var d=c[a],e=d.parentNode,f=$(d).find("rdg, lem, sic, corr"),g=new MeiLib.Alt(d,MeiLib.XMLID(d),MeiLib.XMLID(e),d.localName);for(g.altitems={},b=0;b<f.length;b++){var h=f[b],i=$(h).attr("source"),j=$(h).attr("resp"),k=$(h).attr("n"),l=$(h).prop("localName"),m=MeiLib.XMLID(h);g.altitems[m]=new MeiLib.Variant(h,m,l,i,j,k)}this.ALTs[MeiLib.XMLID(d)]=g}},MeiLib.MeiDoc.prototype.initAltgroups=function(){{var a,b;this.ALTs}for(annots=$(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]'),this.altgroups={},a=0;a<annots.length;a++){for(altgroup=[],token_list=$(annots[a]).attr("plist").split(" "),b=0;b<token_list.length;b++)altgroup.push(token_list[b].replace("#",""));for(b in altgroup)this.altgroups[altgroup[b]]=altgroup}},MeiLib.MeiDoc.prototype.selectDefaultAlternative=function(a){var b={};if("choice"===a.localName){var c=$(a).find("corr")[0];if(c)b.alt_item_xml_id=MeiLib.XMLID(c),b.alt_item=c;else{var d=$(a).find("sic")[0];d?(b.alt_item_xml_id=MeiLib.XMLID(d),b.alt_item=d):b={}}}else{var e=$(a).find("lem")[0];e?(b.alt_item_xml_id=MeiLib.XMLID(e),b.alt_item=e):b={}}return b},MeiLib.MeiDoc.prototype.initSectionView=function(a){a=a||{},this.sectionview_score=this.rich_score.cloneNode(!0),this.sectionplane={};var b,c=$(this.sectionview_score).find("app, choice"),d=this.sectionview_score,e=this.sectionplane,f=this.ALTs,g=this.xmlDoc,h=this;return $(c).each(function(c,i){var j=MeiLib.XMLID(i),k=a[j];if(k){b=k.xmlID;var l=$(d).find(k.tagname+'[xml\\:id="'+b+'"]')[0];if(!l)throw new MeiLib.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+b+"'.")}else{var m=h.ALTs[j].getDefaultItem();m&&(b=m.xmlID,l=m.elem)}var n=i.parentNode,o=g.createProcessingInstruction("MEI2VF",'rdgStart="'+j+'"');if(n.insertBefore(o,i),l){var c,p=l.childNodes;for(c=0;c<p.length;++c)n.insertBefore(p.item(c).cloneNode(!0),i)}var q=g.createProcessingInstruction("MEI2VF",'rdgEnd="'+j+'"');n.insertBefore(q,i),n.removeChild(i),e[j]=[],f[j].altitems[b]&&e[j].push(f[j].altitems[b])}),this.sectionview_score},MeiLib.MeiDoc.prototype.updateSectionView=function(a){var b=function(a,b){var c,d=function(a,b){var c=0;for(var d in a)void 0!==a[d]&&a[d]===b[d]&&c++;return console.log("vars_match: "+c),c},e=0;for(var f in a)M=d(a[f],b),M>e&&(e=M,c=a[f]);return c};for(altID in a){var c=this.ALTs,d=[];if("string"==typeof a[altID]&&(a[altID]=[a[altID]]),a[altID].length>0)$(a[altID]).each(function(){d.push(c[altID].altitems[this])});else{var e=this.ALTs[altID].getDefaultItem();e&&d.push(e)}if(altgroup=this.altgroups[altID]){var f;for(f=0;f<altgroup.length;f++){altID__=altgroup[f];var g=[];$(d).each(function(){g.push(b(c[altID__].altitems,this))}),this.replaceAltInstance({appXmlID:altID__,replaceWith:g})}}else this.replaceAltInstance({appXmlID:altID,replaceWith:d})}},MeiLib.MeiDoc.prototype.replaceAltInstance=function(a){var b=function(a,b){var c,d=a;for(c=0;c<b.length;++c)d.push(b.item(c));return d},c=a.appXmlID,d=$(this.sectionview_score).find("[xml\\:id="+this.ALTs[c].parentID+"]")[0];if("undefined"!=typeof d){var e=d.childNodes,f=a.replaceWith,g=[],h=this.rich_score;if(f){var i;for(i=0;i<f.length;++i){var j=f[i],k=j.xmlID,l=$(h).find(j.tagname+'[xml\\:id="'+k+'"]')[0];g=b(g,l.childNodes)}}console.log(g);var m=function(a,b){return a=a.replace("'",'"'),b=b.replace("'",'"'),a===b},n=!1,o=!1,p=null;if($(e).each(function(){var a=this;7===a.nodeType?"MEI2VF"===a.nodeName&&m(a.nodeValue,'rdgStart="'+c+'"')?(n=!0,o=!0):"MEI2VF"===a.nodeName&&m(a.nodeValue,'rdgEnd="'+c+'"')&&(n=!1,p=a):n&&d.removeChild(a)}),!o)throw"processing instruction not found";if(n)throw"Unmatched <?MEI2VF rdgStart?>";var q;return q=p?function(a){d.insertBefore(a,p)}:function(a){d.appendChild(a)},$.each(g,function(){q(this.cloneNode(!0))}),this.sectionplane[c]=a.replaceWith,this.sectionview_score}},MeiLib.MeiDoc.prototype.getSectionViewSlice=function(a){return MeiLib.SliceMEI(this.sectionview_score,a)},MeiLib.MeiDoc.prototype.getRichSlice=function(a){var b=new MeiLib.MeiDoc;return b.xmlDoc=this.xmlDoc,b.rich_head=this.rich_head.cloneNode(!0),b.rich_music=this.rich_music.cloneNode(!0),b.rich_score=MeiLib.SliceMEI(this.rich_score,a),b.sourceList=this.sourceList,b.editorList=this.editorList,b.ALTs=this.ALTs,b.altgroups=this.altgroups,b};var MEI2VF=function(a,b,c,d,e){return a.Converter=function(a){return a&&this.initConfig(a),this},a.Converter.prototype={BOTTOM:c.Annotation.VerticalJustify.BOTTOM,defaults:{page_width:800,page_margin_top:60,page_margin_left:20,page_margin_right:20,systemSpacing:90,staveSpacing:60,autoStaveConnectorLine:!0,labelMode:null,maxHyphenDistance:75,lyricsFont:{family:"Times",size:15},annotFont:{family:"Times",size:15,weight:"Italic"},dynamFont:{family:"Times",size:18,weight:"bold italic"},tempoFont:{family:"Times",size:17,weight:"bold"},staff:{vertical_bar_width:20,top_text_position:1.5,bottom_text_position:7.5}},initConfig:function(b){var c=this;return c.cfg=d.extend(!0,{},c.defaults,b),c.systemInfo=new a.SystemInfo,c.printSpace={top:c.cfg.page_margin_top-40,left:c.cfg.page_margin_left,right:c.cfg.page_width-c.cfg.page_margin_right,width:Math.floor(c.cfg.page_width-c.cfg.page_margin_right-c.cfg.page_margin_left)-1},c},reset:function(){var b=this;return b.systemInfo.init(b.cfg,b.printSpace),b.unresolvedTStamp2=[],b.systems=[],b.allVexMeasureStaffs=[],b.allBeams=[],b.allTuplets=[],b.dynamics=new a.Dynamics(b.systemInfo,b.cfg.dynamFont),b.directives=new a.Directives(b.systemInfo,b.cfg.annotFont),b.fermatas=new a.Fermatas(b.systemInfo),b.ties=new a.Ties(b.systemInfo,b.unresolvedTStamp2),b.slurs=new a.Ties(b.systemInfo,b.unresolvedTStamp2),b.hairpins=new a.Hairpins(b.systemInfo,b.unresolvedTStamp2),b.hyphenation=new a.Hyphenation(b.cfg.lyricsFont,b.printSpace.right,b.cfg.maxHyphenDistance),b.notes_by_id={},b.currentSystem_n=0,b.pendingSystemBreak=!1,b.pendingSectionBreak=!0,b.currentVoltaType=null,b},process:function(a){var b=this;return b.reset(),b.systemInfo.processScoreDef(d(a).find("scoreDef")[0]),b.processSections(a),b.directives.createVexFromInfos(b.notes_by_id),b.dynamics.createVexFromInfos(b.notes_by_id),b.fermatas.createVexFromInfos(b.notes_by_id),b.ties.createVexFromInfos(b.notes_by_id),b.slurs.createVexFromInfos(b.notes_by_id),b.hairpins.createVexFromInfos(b.notes_by_id),b},draw:function(a){var b=this;return b.drawSystems(a),b.drawVexBeams(b.allBeams,a),b.drawVexTuplets(b.allTuplets,a),b.ties.setContext(a).draw(),b.slurs.setContext(a).draw(),b.hairpins.setContext(a).draw(),b.hyphenation.setContext(a).draw(),b},getStaffArea:function(){var a,b;a=this.systemInfo.getCurrentLowestY();var b,c,d,e,f,g=this.getAllVexMeasureStaffs();for(b=g.length,e=0;b--;)if(g[b]){for(d=0,c=g[b].length;c--;)f=g[b][c],f&&(d=Math.max(d,f.getNoteStartX()));for(c=g[b].length;c--;)f=g[b][c],f&&(e=Math.max(e,d+f.getWidth()))}return{width:e,height:a}},getAllVexMeasureStaffs:function(){return this.allVexMeasureStaffs},getSystems:function(){return this.systems},getNotes:function(){return this.notes_by_id},createNewSystem:function(){var b,c,d=this;return a.L("Converter.createNewSystem()","{enter}"),d.pendingSystemBreak=!1,d.currentSystem_n+=1,c={x:d.printSpace.left,y:1===d.currentSystem_n?d.printSpace.top:d.systemInfo.getCurrentLowestY()+d.cfg.systemSpacing,w:d.printSpace.width},b=new a.System({leftMar:d.systemInfo.getLeftMar(),coords:c,staffYs:d.systemInfo.getYs(c.y),labels:d.getStaffLabels()}),d.pendingSectionBreak?(d.pendingSectionBreak=!1,d.systemInfo.forceSectionStartInfos()):d.systemInfo.forceStaveStartInfos(),d.hyphenation.addLineBreaks(d.systemInfo.getAllStaffInfos(),{system:b}),d.systems[d.currentSystem_n]=b,b},processSections:function(a){var b=this;d(a).find("section").each(function(){b.processSection(this)})},processSection:function(a){var b,c,e=this,f=d(a).children();for(b=0,c=f.length;c>b;b+=1)e.processSectionChild(f[b])},processEnding:function(a){var b,c,e=this,f=d(a).children();for(b=0,c=f.length;c>b;b+=1)e.currentVoltaType={},0===b&&(e.currentVoltaType.start=d(a).attr("n")),b===c-1&&(e.currentVoltaType.end=!0),e.processSectionChild(f[b]);e.currentVoltaType=null},processSectionChild:function(b){var c=this;switch(b.localName){case"measure":c.processMeasure(b);break;case"scoreDef":c.systemInfo.processScoreDef(b);break;case"staffDef":c.systemInfo.processStaffDef(b);break;case"sb":c.setPendingSystemBreak(b);break;case"ending":c.processEnding(b);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <section>")}},setPendingSystemBreak:function(){this.pendingSystemBreak=!0},processMeasure:function(b){var c,e,f,g,h,i,j=this;j.pendingSectionBreak||j.pendingSystemBreak?(i=j.systems.length,h=j.createNewSystem(),e=!0):(i=j.systems.length-1,h=j.systems[i],e=!1),a.L("Converter.processMeasure()","{enter}"),c=+b.getAttribute("n"),f=b.getAttribute("left"),g=b.getAttribute("right");var k=[],l=[],m=[],n=[],o=[],p=[],q=[],r=[];d(b).find("*").each(function(){switch(this.localName){case"staff":k.push(this);break;case"dir":l.push(this);break;case"tie":n.push(this);break;case"slur":m.push(this);break;case"hairpin":o.push(this);break;case"tempo":p.push(this);break;case"dynam":q.push(this);break;case"fermata":r.push(this)}});var s=j.initializeMeasureStaffs(h,k,f,g);j.allVexMeasureStaffs[c]=s;var t=new a.StaveVoices;d.each(k,function(){j.processStaffEvents(s,this,c,t)}),j.directives.createInfos(l,b),j.dynamics.createInfos(q,b),j.fermatas.createInfos(r,b),j.ties.createInfos(n,b,j.systemInfo),j.slurs.createInfos(m,b,j.systemInfo),j.hairpins.createInfos(o,b,j.systemInfo),h.addMeasure(new a.Measure({element:b,n:c,staffs:s,voices:t,startConnectorCfg:e?{labelMode:j.cfg.labelMode,models:j.systemInfo.startConnectorInfos,staffs:s,system_n:j.currentSystem_n}:null,inlineConnectorCfg:{models:j.systemInfo.inlineConnectorInfos,staffs:s,barline_l:f,barline_r:g},tempoElements:p,tempoFont:j.cfg.tempoFont}))},initializeMeasureStaffs:function(b,e,f,g){var h,i,j,k=this,l=!0,m={},n=0,o={},p=0;return j=[],d.each(e,function(){if(i=+d(this).attr("n"),!i)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".');h=k.createVexStaff(b.getStaffYs()[i]),j[i]=h,h.setBegBarType(f?a.tables.barlines[f]:c.Barline.type.NONE),g&&h.setEndBarType(a.tables.barlines[g]),l&&k.currentVoltaType&&k.addStaffVolta(h),k.addStaffClef(h,i),m[i]=h.getModifierXShift(),n=Math.max(n,m[i]),l=!1}),d.each(j,function(a,b){b&&(m[a]!==n?k.addStaffKeySig(b,a,n-m[a]+10):k.addStaffKeySig(b,a),o[a]=b.getModifierXShift(),p=Math.max(p,o[a]))}),d.each(j,function(a,b){b&&(o[a]!==p?k.addStaffTimeSig(b,a,p-o[a]+15):k.addStaffTimeSig(b,a))}),j},createVexStaff:function(a){var b,d=this;return b=new c.Stave,b.init(0,a,1e3,d.cfg.staff),b.options.bottom_text_position=d.cfg.staff.bottom_text_position,b},addStaffClef:function(a,b){var c,d=this;c=d.systemInfo.getStaffInfo(b),c.showClefCheck()&&a.addClef(c.getClef())},addStaffKeySig:function(a,b,c){var d,e=this;d=e.systemInfo.getStaffInfo(b),d.showKeysigCheck()&&a.addModifier(new Vex.Flow.KeySignature(d.getKeySpec(),c))},addStaffTimeSig:function(a,b,c){var d,e=this;d=e.systemInfo.getStaffInfo(b),d.showTimesigCheck()&&(a.hasTimeSig=!0,a.addTimeSignature(d.getTimeSig(),c))},addStaffVolta:function(a){var b=this.currentVoltaType;b.start?a.setVoltaType(Vex.Flow.Volta.type.BEGIN,b.start+".",30):b.end?a.setVoltaType(Vex.Flow.Volta.type.END,"",30):b.start||b.end||a.setVoltaType(Vex.Flow.Volta.type.MID,"",30)},getStaffLabels:function(){var a,b,c,d,e=this;if(a={},!e.cfg.labelMode)return a;for(d="full"===e.cfg.labelMode&&1===e.currentSystem_n?"label":"labelAbbr",c=e.systemInfo.getAllStaffInfos(),b=c.length;b--;)c[b]&&(a[b]=c[b][d]);return a},processStaffEvents:function(a,b,c,e){var f,g,h,i,j=this;g=+d(b).attr("n"),f=a[g],h=function(){var a=j.processNoteLikeElement(this,f,g);return a.vexNote||a},d(b).find("layer").each(function(){j.resolveUnresolvedTimestamps(this,g,c),i=d(this).children().map(h).get(),e.addVoice(j.createVexVoice(i,g),g)})},createVexVoice:function(b,e){var f,g,h=this;if(!d.isArray(b))throw new a.RUNTIME_ERROR("BadArguments","me.createVexVoice() voice_contents argument must be an array.");return g=h.systemInfo.getStaffInfo(e).meter,f=new c.Voice({num_beats:g.count,beat_value:g.unit,resolution:c.RESOLUTION}),f.setStrict(!1),f.addTickables(b),f},resolveUnresolvedTimestamps:function(b,c,e){var f,g=this;if(isNaN(e))throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_events","<measure> must have @n specified");c=c||1,f=e+":"+c+":"+(d(b).attr("n")||"1"),g.unresolvedTStamp2[f]&&(d(g.unresolvedTStamp2[f]).each(function(a){this.setContext({layer:b,meter:g.systemInfo.getStaffInfo(c).meter}),g.unresolvedTStamp2[f][a]=null}),g.unresolvedTStamp2[f]=null)},processNoteLikeElement:function(b,c,d){var e=this;switch(b.localName){case"rest":return e.processRest(b,c);case"mRest":return e.processmRest(b,c,d);case"space":return e.processSpace(b,c);case"note":return e.processNote(b,c,d);case"beam":return e.processBeam(b,c,d);case"tuplet":return e.processTuplet(b,c,d);case"chord":return e.processChord(b,c,d);case"anchoredText":return;default:throw new a.RUNTIME_ERROR("BadArguments",'Rendering of element "'+b.localName+'" is not supported.')}},processNote:function(e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u=this;r=a.Util.attsToObj(e),h=+r.dots,i=r.accid,j=r.ho,k=r.pname,l=r.oct,n=r.tie,o=r.slur,p=+r.staff||g,m=b.XMLID(e);try{if(s={keys:[u.processAttsPitch(e)],clef:u.systemInfo.getClef(g),duration:u.processAttsDuration(e)},u.setStemDir(e,s),t=new c.StaveNote(s),p===g)t.setStave(f);else{var v=u.allVexMeasureStaffs[u.allVexMeasureStaffs.length-1][p];if(!v)throw new a.RUNTIME_ERROR("Error",'Note has staff attribute "'+p+'", but the staff does not exist.');t.setStave(v)}u.processSyllables(t,e,g);try{for(q=0;h>q;q+=1)t.addDotToAll()}catch(w){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the dots of <note>: "+a.Util.attsToString(e))}if(i&&u.processAttrAccid(i,t,0),j&&u.processAttrHo(j,t,f),d.each(d(e).find("artic"),function(){u.addArticulation(t,this)}),r.fermata&&u.fermatas.addFermataToNote(t,r.fermata),d.each(d(e).children(),function(){d(this).remove()}),!k)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute");if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute");return n&&u.processAttrTie(n,m,k,l),o&&u.processAttrSlur(o,m),u.notes_by_id[m]={meiNote:e,vexNote:t,system:u.currentSystem_n},{vexNote:t,id:m}}catch(x){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <note>: "+a.Util.attsToString(e)+"\nORIGINAL ERROR MESSAGE: "+x.toString())}},processChord:function(e,f,g){var h,i,j,k,l,m,n,o,p,q,r=this,s=[],t=[];k=d(e).children(),q=a.Util.attsToObj(e),m=q.dur,n=b.XMLID(e),j=!!d(e).attr("dots");try{if(m)l=r.translateDuration(+m);else{for(h=0,i=k.length;i>h;h+=1)t.push(+k[h].getAttribute("dur"));l=r.translateDuration(Math.max.apply(Math,t))}for(h=0,i=k.length;i>h;h+=1)s.push(r.processAttsPitch(k[h])),"1"===k[h].getAttribute("dots")&&(j=!0);j&&(l+="d"),p={keys:s,clef:r.systemInfo.getClef(g),duration:l},r.setStemDir(e,p),o=new c.StaveNote(p),o.setStave(f);var u=[];return k.each(function(a){r.processNoteInChord(a,this,e,o),u.push(a)}),j&&o.addDotToAll(),q.ho&&r.processAttrHo(q.ho,o,f),q.fermata&&r.fermatas.addFermataToNote(o,q.fermata),r.notes_by_id[n]={meiNote:e,vexNote:o,index:u,system:r.currentSystem_n},{vexNote:o,id:n}}catch(v){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <chord>:"+v.toString())}},processNoteInChord:function(c,d,e,f){var g,h,i=this;g=a.Util.attsToObj(d),h=b.XMLID(d),g.tie&&i.processAttrTie(g.tie,h,g.pname,g.oct),g.slur&&i.processAttrSlur(g.slur,h),i.notes_by_id[h]={meiNote:e,vexNote:f,index:[c],system:i.currentSystem_n},g.accid&&i.processAttrAccid(g.accid,f,c),g.fermata&&i.fermatas.addFermataToNote(f,g.fermata,c)},processRest:function(d,e){var f,g,h,i,j=this;try{return i=a.Util.attsToObj(d),f=j.processAttsDuration(d,!0),g=new c.StaveNote({keys:["w"===f?"d/5":"b/4"],duration:f+"r"}),h=b.XMLID(d),i.ho&&j.processAttrHo(i.ho,g,e),g.setStave(e),"1"===i.dots&&g.addDotToAll(),i.fermata&&j.fermatas.addFermataToNote(g,i.fermata),j.notes_by_id[h]={meiNote:d,vexNote:g,system:j.currentSystem_n},{vexNote:g,id:h}}catch(k){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <rest>: "+a.Util.attsToString(d))}},processmRest:function(d,e,f){var g,h,i,j,k,l=this;j=l.systemInfo.getStaffInfo(f).meter,k=new Vex.Flow.Fraction(j.count,j.unit);var m,n;2==k.value()?(m=a.tables.durations.breve,n=["b/4"]):4==k.value()?(m=a.tables.durations["long"],n=["b/4"]):(m="w",n=["d/5"]);try{return h=a.Util.attsToObj(d),g=new c.StaveNote({keys:n,duration:m+"r",duration_override:k,align_center:!0}),i=b.XMLID(d),h.ho&&l.processAttrHo(h.ho,g,e),h.fermata&&l.fermatas.addFermataToNote(g,h.fermata),g.setStave(e),l.notes_by_id[i]={meiNote:d,vexNote:g,system:l.currentSystem_n},{vexNote:g,id:i}}catch(o){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <mRest>: "+a.Util.attsToString(d))}},processSpace:function(b,d){var e,f=this;try{return e=new c.GhostNote({duration:f.processAttsDuration(b,!0)+"r"}),e.setStave(d),{vexNote:e}}catch(g){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <space>: "+a.Util.attsToString(b))}},processBeam:function(a,b,e){var f,g=this,h=function(){var a=g.processNoteLikeElement(this,b,e);return a.vexNote||a};return f=d(a).children().map(h).get(),g.allBeams.push(new c.Beam(f)),f},processTuplet:function(a,b,e){var f,g,h,i,j=this,k=function(){var a=j.processNoteLikeElement(this,b,e);return a.vexNote||a};return f=d(a).children().map(k).get(),g=new c.Tuplet(f,{num_notes:+a.getAttribute("num")||3,beats_occupied:+a.getAttribute("numbase")||2}),"ratio"===a.getAttribute("num.format")&&g.setRatioed(!0),h=a.getAttribute("bracket.visible"),h&&g.setBracketed("true"===h?!0:!1),i=a.getAttribute("bracket.place"),i&&g.setTupletLocation("above"===i?1:-1),j.allTuplets.push(g),f},processAttrAccid:function(b,d,e){var f=a.tables.accidentals[b];if(!f)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+b);d.addAccidental(e,new c.Accidental(f))},processAttrHo:function(a,b,c){b.setExtraLeftPx(+a*c.getSpacingBetweenLines()/2)},processAttrTie:function(a,b,c,d){var e,f,g=this;for(e=0,f=a.length;f>e;++e)"i"===a[e]?g.ties.start_tieslur(b,{pname:c,oct:d}):"t"===a[e]&&g.ties.terminate_tie(b,{pname:c,oct:d})},processAttrSlur:function(a,b){var c,e=this;a&&(c=e.parse_slur_attribute(a),d.each(c,function(){"i"===this.letter?e.slurs.start_tieslur(b,{nesting_level:this.nesting_level}):"t"===this.letter&&e.slurs.terminate_slur(b,{nesting_level:this.nesting_level})}))},parse_slur_attribute:function(b){var c,d,e,f,g,h=[];for(c=b.split(" "),e=0,f=c.length;f>e;e+=1)if(d=c[e],1===d.length)h.push({letter:d,nesting_level:0});else{if(2!==d.length)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");if(g=+d[1],!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");h.push({letter:d[0],nesting_level:g})}return h},processAttsPitch:function(b){var c,e;if(c=d(b).attr("pname"),e=d(b).attr("oct"),!c||!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>");return c+"/"+e},addArticulation:function(b,d){var e=new c.Articulation(a.tables.articulations[d.getAttribute("artic")]),f=d.getAttribute("place");f&&e.setPosition(a.tables.positions[f]),b.addArticulation(0,e)},processSyllables:function(a,b,c){var d,e,f=this;e=f.processSyllable(b),e&&(d=f.createAnnot(e.text,f.cfg.lyricsFont).setVerticalJustification(f.BOTTOM),a.addAnnotation(0,d),e.wordpos&&f.hyphenation.addSyllable(d,e.wordpos,c))},processSyllable:function(a){var b=d(a).find("syl")[0];return b?{text:d(b).text(),wordpos:d(b).attr("wordpos")}:void 0},createAnnot:function(a,b){return new c.Annotation(a).setFont(b.family,b.size,b.weight)},getMandatoryAttr:function(b,c){var e=d(b).attr(c);if(!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+c+" is mandatory.");return e},translateDuration:function(b){var c=a.tables.durations[b+""];if(c)return c;throw new a.RUNTIME_ERROR("BadArguments",'The MEI duration "'+b+'" is not supported.')},processAttsDuration:function(a,b){var c,f,g=this;return f=d(a).attr("dur"),f===e&&alert("Could not get duration from:\n"+JSON.stringify(a,null,"	")),c=g.translateDuration(f),b||"1"!==d(a).attr("dots")||(c+="d"),c},setStemDir:function(a,b){var e={down:c.StaveNote.STEM_DOWN,up:c.StaveNote.STEM_UP}[d(a).attr("stem.dir")];e?b.stem_direction=e:b.auto_stem=!0},drawSystems:function(a){for(var b=this,c=b.systems.length;c--;)b.systems[c]&&b.systems[c].format(a).draw(a)},drawVexBeams:function(a,b){d.each(a,function(){this.setContext(b).draw()})},drawVexTuplets:function(a,b){d.each(a,function(){this.setContext(b).draw()})}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a){return a.EventLink=function(a,b){this.init(a,b)},a.EventLink.prototype={init:function(b,c){this.first_ref=new a.EventReference(b),this.last_ref=new a.EventReference(c),this.params={}},setParams:function(a){this.params=a},setFirstRef:function(a){this.first_ref=a},setLastRef:function(a){this.last_ref=a},setFirstId:function(a){this.first_ref.setId(a)},setLastId:function(a){this.last_ref.setId(a)},setFirstTStamp:function(a){this.first_ref.setTStamp(a)},setLastTStamp:function(a){this.last_ref.setTStamp(a)},setContext:function(a){this.meicontext=a},getFirstId:function(){return this.first_ref.getId({meicontext:this.meicontext})},getLastId:function(){return this.last_ref.getId({meicontext:this.meicontext})}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b){return a.EventReference=function(a){this.xmlid=a},a.EventReference.prototype={setId:function(a){this.xmlid=a},setTStamp:function(a){this.tstamp=a,this.xmlid&&this.tryResolveReference(!0)},tryResolveReference:function(){var c,d;if(c=this.tstamp,d=this.meicontext,!c)throw new a.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?b.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},getId:function(a){return a&&a.meicontext&&this.setContext(a.meicontext),this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(a&&a.strict),this.xmlid):null},setContext:function(a){this.meicontext=a}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d,e){return a.Hyphenation=function(a,b,c){var d=this;d.allSyllables=[],d.printSpaceRight=b,d.font=a,d.maxHyphenDistance=c},a.Hyphenation.prototype={WORDBOUND:null,addSyllable:function(a,b,c){var d=this;d.allSyllables[c]||(d.allSyllables[c]=[]),"i"===b&&d.allSyllables[c].push(d.WORDBOUND),d.allSyllables[c].push(a),"t"===b&&d.allSyllables[c].push(d.WORDBOUND)},addLineBreaks:function(a,b){var c,d,e=this;for(c=1,d=a.length;d>c;c+=1)e.allSyllables[c]||(e.allSyllables[c]=[]),e.allSyllables[c].push(b)},setContext:function(a){return this.ctx=a,this},draw:function(){var a,b,d,f,g,h=this;for(h.ctx.setFont(h.font.family,h.font.size,h.font.weight),g=h.ctx.measureText("-").width,a=h.allSyllables.length;a--;)if(h.allSyllables[a])for(b=h.allSyllables[a].length;b--;)if(d=h.allSyllables[a][b],f=h.allSyllables[a][b+1],d!==h.WORDBOUND&&f!==h.WORDBOUND){var i={hyphen_width:g,max_hyphen_distance:h.maxHyphenDistance};
if(i.first_annot=d.system?{x:d.system.getMeasures()[0].getX()}:d,i.last_annot=f===e||f.system?{x:h.printSpaceRight}:f,i.first_annot.y||i.last_annot.y){var j=new c.Hyphen(i);j.setContext(h.ctx).renderHyphen()}}}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d,e){return a.LinkCollection=function(a,b){this.init(a,b)},a.LinkCollection.prototype={init:function(a,b){this.allVexObjects=[],this.allModels=[],this.systemInfo=a,this.unresolvedTStamp2=b},validateAtts:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.validateAtts","Developers have to provide a validateAtts method when inheriting MEI2VF.LinkCollection.")},createVexFromInfos:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.createVexFromInfos","Developers have to provide a createVexFromInfos method when inheriting MEI2VF.LinkCollection.")},createInfos:function(c,e,f){var g=this,h=function(a){return{staff_n:d(a).attr("staff")||"1",layer_n:d(a).attr("layer")||"1"}},i=function(c,e,g){var i=h(e),j=d(g).find('staff[n="'+i.staff_n+'"]'),k=d(j).find('layer[n="'+i.layer_n+'"]').get(0);if(!k){var l=d(j).find("layer");if(l&&!l.attr("n")&&(k=l),!k)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E01","Cannot find layer")}var m=f.getStaffInfo(i.staff_n);if(!m)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E02","Cannot determine staff definition.");var n=m.meter;if(!n.count||!n.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");return b.tstamp2id(c,k,n)},j=function(a){return a.substring(0,a.indexOf("m"))},k=function(a){return a.substring(a.indexOf("+")+1)};d.each(c,function(){var b,c,f,l,m,n,o;if(b=new a.EventLink(null,null),c=a.Util.attsToObj(this),g.validateAtts(c),b.setParams(c),f=c.startid,f?b.setFirstId(f):(l=c.tstamp,l&&(f=i(l,this,e),b.setFirstId(f))),m=c.endid)b.setLastId(m);else if(n=c.tstamp2)if(o=+j(n),o>0){b.setLastTStamp(k(n));var p=h(this),q=+d(e).attr("n")+o,r=q.toString()+":"+p.staff_n+":"+p.layer_n;g.unresolvedTStamp2[r]||(g.unresolvedTStamp2[r]=[]),g.unresolvedTStamp2[r].push(b)}else m=i(k(n),this,e),b.setLastId(m);g.addModel(b)})},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels},setContext:function(a){return this.ctx=a,this},draw:function(){var a=this.ctx;d.each(this.allVexObjects,function(){this.setContext(a).draw()})}},a.Hairpins=function(a,b){this.init(a,b)},Vex.Inherit(a.Hairpins,a.LinkCollection,{init:function(b,c){a.Ties.superclass.init.call(this,b,c)},validateAtts:function(b){if(!b.form)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:createInfos","@form is mandatory in <hairpin> - make sure the xml is valid.")},createVexFromInfos:function(a){var b,c,f,g=this;return f={height:10,y_shift:0,left_shift_px:0,r_shift_px:0},d.each(g.allModels,function(){b=a[this.getFirstId()]||{},c=a[this.getLastId()]||{},b.system!==e&&c.system!==e&&b.system!==c.system||g.createSingleHairpin(b,c,this.params,f)}),this},createSingleHairpin:function(b,d,e,f){var g,h,i,j=this;g=a.tables.positions[e.place],h=a.tables.hairpins[e.form],b.vexNote&&d.vexNote?(i=new c.StaveHairpin({first_note:b.vexNote,last_note:d.vexNote},h),i.setRenderOptions(f),i.setPosition(g),j.allVexObjects.push(i)):(a.L("Hairpins","Hairpin cannot be rendered:"),console.log(arguments))}}),a.Ties=function(a,b){this.init(a,b)},Vex.Inherit(a.Ties,a.LinkCollection,{init:function(b,c){a.Ties.superclass.init.call(this,b,c)},validateAtts:function(){},start_tieslur:function(b,c){var d=new a.EventLink(b,null);d.setParams({linkCond:c}),this.allModels.push(d)},terminate_tie:function(b,c){var d,e,f,g,h;if(h=this.getModels(),d=function(a,b){return a&&b&&a.pname===b.pname&&a.oct===b.oct},!c.pname||!c.oct)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or octave specified for the tie");for(e=!1,f=0;!e&&f<h.length;++f)g=h[f],g.getLastId()||d(g.params.linkCond,c)&&(e=!0,g.setLastId(b));e||this.addModel(new a.EventLink(null,b))},terminate_slur:function(b,c){var d,e,f,g,h=this,i=this.getModels();for(d=function(a,b){return a.nesting_level===b.nesting_level},e=!1,f=0;f<i.length;++f)if(g=i[f],g&&!g.getLastId()&&d(g.params.linkCond,c)){g.setLastId(b),e=!0;break}e||h.addModel(new a.EventLink(null,b))},createVexFromInfos:function(a){var b,c,f=this;return d.each(f.allModels,function(){b=a[this.getFirstId()]||{},c=a[this.getLastId()]||{},b.system!==e&&c.system!==e&&b.system!==c.system?(f.createSingleStaveTie(b,{},this.params),this.params.curvedir=-1===b.vexNote.getStemDirection()?"above":"below",f.createSingleStaveTie({},c,this.params)):f.createSingleStaveTie(b,c,this.params)}),this},createSingleStaveTie:function(a,b,d){var e,f,g,h=this;f=d.bezier,f?(g=h.bezierStringToCps(f),e=new c.Curve(a.vexNote,b.vexNote,{cps:g,y_shift_start:+d.startvo,y_shift_end:+d.endvo})):(e=new c.StaveTie({first_note:a.vexNote,last_note:b.vexNote,first_indices:a.index,last_indices:b.index}),e.setDir(d.curvedir)),h.allVexObjects.push(e)},bezierStringToCps:function(a){for(var b,c=[],d=a.split(" ");d[0];)b=d.splice(0,2),c.push({x:+b[0],y:+b[1]});return c}}),a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.PointerCollection=function(a,b){this.init(a,b)},a.PointerCollection.prototype={BOTTOM:c.Annotation.VerticalJustify.BOTTOM,init:function(a,b){this.allVexObjects=[],this.allModels=[],this.systemInfo=a,this.font=b},createVexFromInfos:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.createVexFromInfos","You have to prodide a createVexFromInfos method when inheriting MEI2VF.PointerCollection.")},createInfos:function(c,e){var f=this,g=function(a){return{staff_n:d(a).attr("staff")||"1",layer_n:d(a).attr("layer")||"1"}},h=function(c,e,h){var i=g(e),j=d(h).find('staff[n="'+i.staff_n+'"]'),k=d(j).find('layer[n="'+i.layer_n+'"]').get(0);if(!k){var l=d(j).find("layer");if(l&&!l.attr("n")&&(k=l),!k)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E01","Cannot find layer")}var m=f.systemInfo.getStaffInfo(i.staff_n);if(!m)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E02","Cannot determine staff definition.");var n=m.meter;if(!n.count||!n.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");return b.tstamp2id(c,k,n)};d.each(c,function(){var b,c,d;if(b=a.Util.attsToObj(this),c=b.startid,!c){if(d=b.tstamp,!d)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos","Neither @startid nor @tstamp are specified");c=h(d,this,e)}f.allModels.push({element:this,atts:b,startid:c})})},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels}},a.Directives=function(a,b){this.init(a,b)},Vex.Inherit(a.Directives,a.PointerCollection,{init:function(b,c){a.Directives.superclass.init.call(this,b,c)},createVexFromInfos:function(b){var e,f,g,h,i=this;for(e=i.allModels.length;e--;){if(f=i.allModels[e],g=b[f.startid],!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");h=new c.Annotation(d(f.element).text().trim()).setFont(i.font.family,i.font.size,i.font.weight),h.setWidth(0),"below"===f.atts.place?g.vexNote.addAnnotation(0,h.setVerticalJustification(i.BOTTOM)):g.vexNote.addAnnotation(0,h)}}}),a.Dynamics=function(a,b){this.init(a,b)},Vex.Inherit(a.Dynamics,a.PointerCollection,{init:function(b,c){a.Dynamics.superclass.init.call(this,b,c)},createVexFromInfos:function(b){var e,f,g,h,i=this;for(e=i.allModels.length;e--;){if(f=i.allModels[e],g=b[f.startid],!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");h=new c.Annotation(d(f.element).text().trim()).setFont(i.font.family,i.font.size,i.font.weight),"above"===f.atts.place?g.vexNote.addAnnotation(0,h):g.vexNote.addAnnotation(0,h.setVerticalJustification(i.BOTTOM))}}}),a.Fermatas=function(a,b){this.init(a,b)},Vex.Inherit(a.Fermatas,a.PointerCollection,{init:function(b,c){a.Fermatas.superclass.init.call(this,b,c)},createVexFromInfos:function(b){var c,d,e,f=this;for(c=f.allModels.length;c--;){if(d=f.allModels[c],e=b[d.startid],!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");f.addFermataToNote(e.vexNote,d.atts.place)}},addFermataToNote:function(b,d,e){var f=new c.Articulation(a.tables.fermata[d]);f.setPosition(a.tables.positions[d]),b.addArticulation(e||0,f)}}),a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Measure=function(a){this.init(a)},a.Measure.prototype={init:function(b){var c=this;c.element=b.element,c.n=b.n,c.staffs=b.staffs,c.voices=b.voices,c.startConnectors=new a.Connectors(b.startConnectorCfg),c.inlineConnectors=new a.Connectors(b.inlineConnectorCfg),c.tieElements=b.tieElements,c.slurElements=b.slurElements,c.hairpinElements=b.hairpinElements,c.tempoElements=b.tempoElements,c.tempoFont=b.tempoFont,c.maxNoteStartX=0,c.meiW=c.readMEIW(c.element)},readMEIW:function(a){return+a.getAttribute("width")||null},getStaffs:function(){return this.staffs},getVoices:function(){return this.voices},getX:function(){return this.getFirstDefinedStaff().x},getN:function(){return this.n},getFirstDefinedStaff:function(){var b,c,d=this;for(b=0,c=d.staffs.length;c>b;b+=1)if(d.staffs[b])return d.staffs[b];throw new a.RUNTIME_ERROR("ERROR","getFirstDefinedStaff(): no staff found in the current measure.")},addTempoToStaves:function(){var b,c,e,f,g,h=this;d.each(h.tempoElements,function(){f=a.Util.attsToObj(this),c=h.staffs[f.staff],g=c.getSpacingBetweenLines()/2,e=new Vex.Flow.StaveTempo({name:d(this).text(),duration:f["mm.unit"],dots:+f["mm.dots"],bpm:+f.mm},c.x,5),f.vo&&e.setShiftY(+f.vo*g),b=c.getModifierXShift()>0?-14:14,c.hasTimeSig&&(b-=24),f.ho&&(b+=+f.ho*g),e.setShiftX(b),e.font=h.tempoFont,c.modifiers.push(e)})},calculateMinWidth:function(){var a=this;a.calculateMaxNoteStartX(),a.calculateRepeatPadding(),a.minVoicesW=a.voices.preFormat(),a.minWidth=a.maxNoteStartX+a.minVoicesW+a.repeatPadding},getMinWidth:function(){return this.minWidth},calculateMaxNoteStartX:function(){var a,b,c,d=this;for(b=d.staffs,a=b.length;a--;)c=b[a],c&&(d.maxNoteStartX=Math.max(d.maxNoteStartX,c.getNoteStartX()))},calculateRepeatPadding:function(){var a=this,b=a.getFirstDefinedStaff();a.repeatPadding=b.modifiers[0].barline==Vex.Flow.Barline.type.REPEAT_BEGIN&&b.modifiers.length>2?20:0},format:function(a,b){for(var d,e,f=this,g=f.w,h=f.staffs.length;h--;)if(f.staffs[h]){if(d=f.staffs[h],b&&"string"==typeof b[h]&&d.setText(b[h],c.Modifier.Position.LEFT,{shift_y:-3}),"function"==typeof d.setX)d.setX(a);else for(d.x=a,d.glyph_start_x=a+5,d.bounds.x=a,e=0;e<d.modifiers.length;e++)d.modifiers[e].x=a;d.start_x=d.x+f.maxNoteStartX,d.setWidth(g)}f.voices.format(f.getFirstDefinedStaff())},draw:function(a){var b,c,d,e=this;for(c=e.staffs,b=c.length;b--;)d=c[b],d&&d.setContext(a).draw();e.voices.draw(a,c),e.startConnectors.setContext(a).draw(),e.inlineConnectors.setContext(a).draw()}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a){return a.DO_LOG=!1,a.setLogging=function(b){a.DO_LOG=b},a.L=function(){a.DO_LOG&&Vex.L("MEI2VF",arguments)},a.RUNTIME_ERROR=function(a,b){this.error_code=a,this.message=b},a.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c){return a.tables={accidentals:{n:"n",f:"b",s:"#",bb:"ff",ss:"##"},durations:{"long":"l",breve:"d",1:"w",2:"h",4:"q",8:"8",16:"16",32:"32",64:"64"},positions:{above:c.Modifier.Position.ABOVE,below:c.Modifier.Position.BELOW},hairpins:{cres:c.StaveHairpin.type.CRESC,dim:c.StaveHairpin.type.DECRESC},articulations:{acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},fermata:{above:"a@a",below:"a@u"},barlines:{single:c.Barline.type.SINGLE,dbl:c.Barline.type.DOUBLE,end:c.Barline.type.END,rptstart:c.Barline.type.REPEAT_BEGIN,rptend:c.Barline.type.REPEAT_END,rptboth:c.Barline.type.REPEAT_BOTH,invis:c.Barline.type.NONE}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d,e){return a.StaffInfo=function(b,c,d,e){var f=this;f.renderWith={clef:c,keysig:d,timesig:e},f.spacing=null,f.staffDefObj=a.Util.attsToObj(b),f.updateMeter(),f.updateStaveLabels(),f.updateSpacing(),f.currentClef=f.convertClef()},a.StaffInfo.prototype={updateMeter:function(){var a=this;a.staffDefObj.hasOwnProperty("meter.count")&&a.staffDefObj.hasOwnProperty("meter.unit")&&(a.meter={count:+a.staffDefObj["meter.count"],unit:+a.staffDefObj["meter.unit"]})},updateStaveLabels:function(){var a,b,c=this;a=c.staffDefObj.label,"string"==typeof a&&(c.label=a),b=c.staffDefObj["label.abbr"],"string"==typeof b&&(c.labelAbbr=b)},updateSpacing:function(){var a,b=this;return a=+b.staffDefObj.spacing,isNaN(a)||(b.spacing=a),b.spacing},forceSectionStartInfo:function(){var a=this;a.renderWith.clef=!0,a.renderWith.keysig=!0,a.renderWith.timesig=!0},forceStaveStartInfo:function(){var a=this;a.renderWith.clef=!0,a.renderWith.keysig=!0},showClefCheck:function(){var a=this;return a.renderWith.clef&&"false"!==a.staffDefObj["clef.visible"]?(a.renderWith.clef=!1,!0):void 0},showKeysigCheck:function(){var a=this;return a.renderWith.keysig&&(a.renderWith.keysig=!1,"false"!==a.staffDefObj["key.sig.show"])?!0:void 0},showTimesigCheck:function(){var a=this;return a.renderWith.timesig&&(a.renderWith.timesig=!1,"norm"===a.staffDefObj["meter.rend"]||a.staffDefObj["meter.rend"]===e)?!0:void 0},convertClef:function(){var b,d,f,g,h=this;if(b=h.staffDefObj["clef.shape"],!b)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute clef.shape is mandatory.");if(d=h.staffDefObj["clef.line"],f=h.staffDefObj["clef.dis"],g=h.staffDefObj["clef.dis.place"],"G"===b&&(!d||"2"===d))return"8"===f&&"below"===g&&c.clefProperties.values.octave!=e?"octave":"treble";if("F"===b&&(!d||"4"===d))return"bass";if("C"===b&&"3"===d)return"alto";if("C"===b&&"4"===d)return"tenor";throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+b+'" '+(d?'clef.line="'+d+'"':"")+" ]")},getClef:function(){return this.currentClef},getKeySpec:function(){var b,c,d,f=this;if(f.staffDefObj["key.pname"]!==e){if(b=f.staffDefObj["key.pname"].toUpperCase(),c=f.staffDefObj["key.accid"],c!==e)switch(c){case"s":b+="#";break;case"f":b+="b";break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}return d=f.staffDefObj["key.mode"],d!==e&&(b+="major"===d?"":"m"),b}return"C"},getTimeSig:function(){var a,b,c,d=this;return(a=d.staffDefObj["meter.sym"])?"cut"===a?"C|":"C":(b=d.staffDefObj["meter.count"],c=d.staffDefObj["meter.unit"],b&&c?b+"/"+c:e)},updateRenderWith:function(a){var b,c,d=this;b={clef:!1,keysig:!1,timesig:!1},c=function(b){return d.staffDefObj[b]===a[b]},c("clef.shape")&&c("clef.line")||(b.clef=!0),c("key.pname")&&c("key.accid")&&c("key.mode")||(b.keysig=!0),c("meter.count")&&c("meter.unit")||(b.timesig=!0),d.renderWith=b},updateDef:function(b){var c,d=this;c=a.Util.attsToObj(b),d.updateRenderWith(c),d.staffDefObj=c,d.updateMeter(),d.updateStaveLabels(),d.updateSpacing(),d.currentClef=d.convertClef()}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Connectors=function(a){var b=this;b.allVexConnectors=[],a&&b.init(a)},a.Connectors.prototype={vexTypes:{line:c.StaveConnector.type.SINGLE_LEFT,brace:c.StaveConnector.type.BRACE,bracket:c.StaveConnector.type.BRACKET,none:null,singleright:c.StaveConnector.type.SINGLE_RIGHT},vexTypesBarlineRight:{single:c.StaveConnector.type.SINGLE_RIGHT,dbl:c.StaveConnector.type.THIN_DOUBLE,end:c.StaveConnector.type.BOLD_DOUBLE_RIGHT,rptend:c.StaveConnector.type.BOLD_DOUBLE_RIGHT,invis:null},vexTypesBarlineLeft:{single:c.StaveConnector.type.SINGLE_LEFT,dbl:c.StaveConnector.type.THIN_DOUBLE,end:c.StaveConnector.type.BOLD_DOUBLE_LEFT,rptstart:c.StaveConnector.type.BOLD_DOUBLE_LEFT,invis:null},init:function(a){var b,e,f,g,h,i,j=this,k=a.models,l=a.staffs,m=a.barline_l,n=a.barline_r,o=a.system_n;i=a.labelMode,d.each(k,function(){b=n?j.vexTypesBarlineRight[n]:j.vexTypes[this.symbol],e=l[this.top_staff_n],f=l[this.bottom_staff_n],"number"==typeof b&&e&&f&&(g=new c.StaveConnector(e,f),g.setType(b),j.allVexConnectors.push(g),"full"===i?h=1===o?this.label:this.labelAbbr:"abbr"===i&&(h=this.labelAbbr),h&&g.setText(h)),m&&(b=j.vexTypesBarlineLeft[m],"number"==typeof b&&e&&f&&(g=new c.StaveConnector(e,f),g.setType(b),b===c.StaveConnector.type.BOLD_DOUBLE_LEFT&&(g.checkShift=!0),j.allVexConnectors.push(g)))})},getAll:function(){return this.allVexConnectors},setContext:function(a){return this.ctx=a,this},draw:function(){var a,b,c,d,e=this;for(a=0,b=e.allVexConnectors.length;b>a;a+=1)c=e.allVexConnectors[a],c.checkShift&&(d=c.top_stave.getModifierXShift(),d>0&&c.setXShift(d)),c.setContext(e.ctx).draw()}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c){return a.StaffVoice=function(a,b){this.voice=a,this.staff_n=b},a.StaveVoices=function(){this.all_voices=[],this.formatter=new c.Formatter},a.StaveVoices.prototype={addStaffVoice:function(a){this.all_voices.push(a)},addVoice:function(b,c){this.addStaffVoice(new a.StaffVoice(b,c))},reset:function(){this.all_voices=[]},preFormat:function(){var a,b,c,d=this;for(a=d.all_voices,d.vexVoices=[],d.vexVoicesStaffWise={},c=a.length;c--;)d.vexVoices.push(a[c].voice),b=a[c].staff_n,d.vexVoicesStaffWise[b]?d.vexVoicesStaffWise[b].push(a[c].voice):d.vexVoicesStaffWise[b]=[a[c].voice];return d.formatter.preCalculateMinTotalWidth(d.vexVoices),d.formatter.getMinTotalWidth()},format:function(a){var b,c,d=this;c=d.formatter;for(b in d.vexVoicesStaffWise)c.joinVoices(d.vexVoicesStaffWise[b],{align_rests:!0});c.formatToStave(d.vexVoices,a)},draw:function(a,b){var c,d,e=this.all_voices;for(c=0;c<e.length;++c)d=e[c],d.voice.draw(a,b[d.staff_n])}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a){return a.System=function(a){this.init(a)},a.System.prototype={LABEL_PADDING:20,init:function(a){var b=this;b.leftMar=a.leftMar,b.coords=a.coords,b.staffYs=a.staffYs,b.labels=a.labels,b.measures=[]},getStaffYs:function(){return this.staffYs},addMeasure:function(a){this.measures.push(a)},getMeasure:function(a){return this.measures[a]},getMeasures:function(){return this.measures},calculateInitialIndent:function(a){var b,c,d,e,f,g=this,h=0;a.setFont("Times",16);for(b in g.labels)f=g.labels[b],"string"==typeof f&&(c=a.measureText(g.labels[b]).width,c>h&&(h=c));for(d=g.getMeasures()[0].startConnectors.getAll(),e=d.length;e--;)f=d[e].text,"string"==typeof f&&(c=a.measureText(g.labels[b]).width,c>h&&(h=c));g.leftMar=0===h?0:h+g.LABEL_PADDING},calculateMeasureMinWidths:function(){for(var a=this.measures,b=a.length;b--;)a[b].calculateMinWidth()},calculateMissingMeasureWidths:function(){var a,b,c,d=this,e=0,f=0;for(a=0,b=d.measures.length;b>a;a+=1)null===d.measures[a].meiW?(f+=1,e+=d.measures[a].getMinWidth()):e+=d.measures[a].meiW;for(c=Math.floor((d.coords.w-d.leftMar-e)/f),a=0,b=d.measures.length;b>a;a+=1)d.measures[a].w=null===d.measures[a].meiW?c+d.measures[a].getMinWidth():d.measures[a].meiW},format:function(a){var b,c,d,e,f,g=this;for("number"!=typeof g.leftMar&&g.calculateInitialIndent(a),g.calculateMeasureMinWidths(),g.calculateMissingMeasureWidths(),e=g.coords.x+g.leftMar,d=g.getMeasures(),b=0,c=d.length;c>b;b+=1)d[b]&&(f=0===b?g.labels:null,d[b].format(e,f),e+=d[b].w),d[b].addTempoToStaves();return g},draw:function(a){for(var b=this,c=b.measures.length;c--;)b.measures[c]&&b.measures[c].draw(a)}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a,b,c,d,e){return a.SystemInfo=function(){},a.SystemInfo.prototype={STAVE_HEIGHT:40,init:function(a,b){var c=this;c.cfg=a,c.printSpace=b,c.currentStaffInfos=[],c.systemLeftMar=e,c.currentLowestY=0,c.startConnectorInfos={},c.inlineConnectorInfos={}},setLeftMar:function(a){this.systemLeftMar=a},getLeftMar:function(){return this.systemLeftMar},setModelForStaveRange:function(a,b,c){c=c||"",a[b.top_staff_n+":"+b.bottom_staff_n+c]=b},setConnectorModels:function(b,c,e){var f,g,h,i,j=this;h=c.first_n,i=c.last_n,f=d(b).attr("symbol"),g=d(b).attr("barthru"),a.L("Converter.setConnectorModels() {2}","symbol: "+f," range.first_n: "+h," range.last_n: "+i),j.setModelForStaveRange(j.startConnectorInfos,{top_staff_n:h,bottom_staff_n:i,symbol:f||"line",label:d(b).attr("label"),labelAbbr:d(b).attr("label.abbr")}),!e&&j.cfg.autoStaveConnectorLine&&j.setModelForStaveRange(j.startConnectorInfos,{top_staff_n:h,bottom_staff_n:i,symbol:"none"===f?"none":"line"},"autoline"),"true"===g&&j.setModelForStaveRange(j.inlineConnectorInfos,{top_staff_n:h,bottom_staff_n:i,symbol:"singleright"})},getStaffInfo:function(a){return this.currentStaffInfos[a]},getAllStaffInfos:function(){return this.currentStaffInfos},getClef:function(b){var c,d=this;if(c=d.currentStaffInfos[b],!c)throw new a.RUNTIME_ERROR("MEI2VF.getClefForStaffNr():E01","No staff definition for staff n="+b);return c.getClef()},getCurrentLowestY:function(){return this.currentLowestY},setCurrentLowestY:function(a){this.currentLowestY=a},getYs:function(a){var b,c,d,e,f,g=this,h=!0,i=[];for(b=0,c=1,d=g.currentStaffInfos.length;d>c;c+=1)g.currentStaffInfos[c]&&(e=g.currentStaffInfos[c].spacing,b+=h?0:null!==e?g.STAVE_HEIGHT+g.currentStaffInfos[c].spacing:g.STAVE_HEIGHT+g.cfg.staveSpacing,i[c]=a+b,h=!1);return f=a+b+g.STAVE_HEIGHT,f>g.currentLowestY&&(g.currentLowestY=f),i},forceSectionStartInfos:function(){for(var a=this,b=a.currentStaffInfos.length;b--;)a.currentStaffInfos[b]&&a.currentStaffInfos[b].forceSectionStartInfo()},forceStaveStartInfos:function(){for(var a=this,b=a.currentStaffInfos.length;b--;)a.currentStaffInfos[b]&&a.currentStaffInfos[b].forceStaveStartInfo()},processScoreDef:function(a){var b,c,e,f,g=this;for(f=d(a).attr("system.leftmar"),"string"==typeof f&&g.setLeftMar(+f),e=d(a).children(),b=0,c=e.length;c>b;b+=1)g.processScoreDef_child(e[b])},processScoreDef_child:function(b){var c=this;switch(b.localName){case"staffGrp":c.processStaffGrp(b);break;case"pgHead":break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <scoreDef>")}},processStaffGrp:function(b,c){var e=this,f={};return d(b).children().each(function(b,c){var d=e.processStaffGrp_child(c);a.L("Converter.processStaffGrp() {1}.{a}","childRange.first_n: "+d.first_n," childRange.last_n: "+d.last_n),0===b&&(f.first_n=d.first_n),f.last_n=d.last_n}),e.setConnectorModels(b,f,c),f},processStaffGrp_child:function(b){var c,d=this;switch(b.localName){case"staffDef":return c=d.processStaffDef(b),{first_n:c,last_n:c};case"staffGrp":return d.processStaffGrp(b,!0);default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <staffGrp>")}},processStaffDef:function(b){var c,e,f=this;return c=+d(b).attr("n"),e=f.currentStaffInfos[c],e?e.updateDef(b):f.currentStaffInfos[c]=new a.StaffInfo(b,!0,!0,!0),c}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery);Vex.Flow.KeySignature=function(){function a(a,b){arguments.length>0&&this.init(a,b)}return Vex.Inherit(a,Vex.Flow.StaveModifier,{init:function(b,c){a.superclass.init();var d=c||10;this.setPadding(d),this.glyphFontScale=38,this.accList=Vex.Flow.keySignature(b)},addAccToStave:function(a,b){var c=new Vex.Flow.Glyph(b.glyphCode,this.glyphFontScale);this.placeGlyphOnLine(c,a,b.line),a.addGlyph(c)},addModifier:function(a){this.convertAccLines(a.clef,this.accList[0].glyphCode);for(var b=0;b<this.accList.length;++b)this.addAccToStave(a,this.accList[b])},addToStave:function(a,b){return 0===this.accList.length?this:(b||a.addGlyph(this.makeSpacer(this.padding)),this.addModifier(a),this)},convertAccLines:function(a,b){var c,d=0,e="tenor"===a&&"v18"===b?!0:!1;switch(a){case"bass":d=1;break;case"alto":d=.5;break;case"tenor":e||(d=-.5)}var f;if(e)for(c=[3,1,2.5,.5,2,0,1.5],f=0;f<this.accList.length;++f)this.accList[f].line=c[f];else if("treble"!=a)for(f=0;f<this.accList.length;++f)this.accList[f].line+=d}}),a}(),Vex.Flow.Hyphen=function(){function a(a){arguments.length>0&&this.init(a)}return a.prototype={init:function(a){this.max_hyphen_distance=a.max_hyphen_distance||75,this.font={family:"Arial",size:10,style:""},this.config=a,this.context=null},setContext:function(a){return this.context=a,this},setFont:function(a){return this.font=a,this},renderHyphen:function(){var a=this.config,b=this.context,c=a.hyphen_width||b.measureText("-").width,d=a.first_annot,e=a.last_annot,f=d.text?d.x+d.text_width:d.x,g=e.x,h=g-f;if(h>c)for(var i=d.y&&e.y?(d.y+e.y)/2:d.y||e.y,j=Math.ceil(h/this.max_hyphen_distance),k=h/(j+1);j--;)f+=k,b.fillText("-",f-c/2,i)},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render hyphens.");var a=this.context;return a.save(),a.setFont(this.font.family,this.font.size,this.font.style),this.renderHyphen(),a.restore(),!0}},a}(),Vex.Flow.durationToTicks.durations.d||(Vex.Flow.durationToTicks.durations.d=Vex.Flow.RESOLUTION/.5),Vex.Flow.durationToGlyph.duration_codes.d||(Vex.Flow.durationToGlyph.duration_codes.d={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadDoubleWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}}),Vex.Flow.durationToTicks.durations.l||(Vex.Flow.durationToTicks.durations.l=Vex.Flow.RESOLUTION/.25),Vex.Flow.durationToGlyph.duration_codes.l||(Vex.Flow.durationToGlyph.duration_codes.l={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadQuadWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}}),Vex.Flow.Font.glyphs.gClef={x_min:0,x_max:948,ha:944,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 948 35 l 948 15 b 693 -328 948 -141 850 -269 b 728 -536 711 -454 728 -536 b 736 -633 734 -571 736 -603 b 489 -920 736 -853 588 -914 b 456 -921 477 -920 466 -921 b 190 -700 225 -921 190 -777 b 196 -650 190 -671 195 -650 b 323 -532 204 -587 259 -536 l 333 -532 b 476 -665 409 -532 469 -592 l 476 -675 b 378 -806 476 -738 435 -788 b 343 -815 365 -812 356 -812 b 330 -826 336 -818 330 -820 b 343 -841 330 -830 335 -836 b 459 -869 372 -862 412 -869 l 486 -869 b 673 -638 503 -869 673 -867 b 665 -543 673 -610 671 -578 l 633 -347 l 626 -347 b 531 -353 595 -351 563 -353 b 10 94 301 -353 36 -245 b 8 136 8 108 8 122 b 445 788 8 406 239 612 l 428 876 b 419 1019 421 925 419 973 b 645 1543 419 1273 511 1484 b 750 1410 645 1543 696 1534 b 811 1141 790 1319 811 1229 b 528 594 811 951 715 767 b 573 354 542 518 557 445 b 591 357 578 357 585 357 l 606 357 b 948 35 785 357 937 216 m 655 1320 b 477 948 545 1315 477 1092 b 480 897 477 930 477 913 b 491 829 480 889 486 862 b 745 1177 641 942 728 1061 b 748 1208 746 1189 748 1198 b 655 1320 748 1284 701 1320 m 120 22 l 120 11 b 531 -302 129 -234 378 -302 b 623 -291 570 -302 602 -298 l 547 157 b 382 -3 455 141 382 95 l 382 -17 b 476 -155 385 -74 448 -143 b 497 -181 487 -161 497 -172 b 480 -192 497 -186 491 -192 b 451 -186 473 -192 463 -190 b 300 0 385 -165 322 -95 b 291 62 294 20 291 41 b 517 344 291 188 391 307 l 482 563 b 120 22 298 427 120 256 m 683 -276 b 833 -64 781 -234 833 -162 l 833 -49 b 609 162 827 69 727 162 l 603 162 b 683 -276 633 4 661 -148 "},Vex.Flow.Font.glyphs.gClef8vb={x_min:0,x_max:937,ha:930,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 937 46 l 937 24 b 685 -316 937 -130 839 -256 b 717 -521 704 -441 717 -521 b 727 -622 724 -557 727 -591 b 533 -896 727 -799 624 -872 b 588 -963 563 -906 588 -928 b 546 -1030 588 -1008 559 -1016 b 535 -1049 538 -1036 535 -1042 b 540 -1070 535 -1054 538 -1061 b 553 -1116 549 -1085 553 -1100 b 493 -1203 553 -1154 531 -1189 b 435 -1211 473 -1211 455 -1211 b 315 -1133 391 -1211 328 -1183 b 314 -1120 314 -1128 314 -1124 b 382 -1030 314 -1082 349 -1040 b 391 -1023 388 -1029 391 -1026 b 388 -1016 391 -1021 389 -1018 b 365 -963 372 -1000 365 -981 b 396 -903 365 -941 377 -918 b 185 -680 213 -879 185 -750 b 190 -634 185 -652 189 -634 b 319 -518 200 -570 252 -521 l 329 -518 b 468 -650 402 -518 462 -578 l 468 -657 b 371 -790 468 -720 428 -770 b 337 -799 360 -797 350 -797 b 326 -809 330 -801 326 -805 b 337 -825 326 -813 329 -818 b 454 -853 367 -846 407 -853 l 476 -853 b 665 -620 493 -853 665 -850 b 657 -526 665 -592 662 -561 l 626 -336 l 617 -336 b 531 -342 589 -339 560 -342 b 7 102 301 -342 35 -237 b 6 144 6 116 6 130 b 435 792 6 414 234 617 l 423 881 b 413 1025 416 930 413 979 b 637 1541 413 1275 501 1483 b 741 1411 637 1541 689 1532 b 801 1142 780 1320 801 1231 b 522 599 801 953 707 773 b 566 363 533 524 550 452 b 585 365 571 365 577 365 l 601 365 b 937 46 777 365 927 225 m 435 -1196 b 484 -1148 462 -1196 484 -1170 b 482 -1130 484 -1142 484 -1135 b 447 -1082 473 -1110 462 -1095 b 426 -1064 440 -1075 430 -1070 b 406 -1053 420 -1061 413 -1053 b 385 -1064 396 -1053 391 -1061 b 379 -1075 382 -1067 379 -1070 b 364 -1117 370 -1085 364 -1102 b 365 -1127 364 -1120 365 -1124 b 435 -1196 374 -1170 409 -1196 m 540 -966 l 540 -956 b 528 -925 540 -944 535 -930 b 473 -903 514 -911 493 -903 b 430 -937 452 -906 433 -914 b 455 -983 430 -956 442 -970 b 490 -1014 465 -993 476 -1005 b 508 -1021 497 -1018 503 -1021 b 540 -966 531 -1021 538 -986 m 648 1322 b 468 946 538 1315 468 1089 b 470 902 468 930 469 916 b 484 833 470 893 476 867 b 736 1179 634 946 717 1063 b 738 1208 738 1189 738 1198 b 648 1322 738 1284 694 1322 m 116 35 l 116 21 b 522 -290 123 -223 370 -290 b 615 -279 561 -290 594 -286 l 540 165 b 375 8 447 150 375 104 l 375 -6 b 468 -143 379 -62 440 -132 b 489 -168 480 -148 489 -160 b 470 -179 489 -175 483 -179 b 442 -175 463 -179 454 -178 b 293 11 379 -153 315 -83 b 286 70 288 31 286 50 b 508 351 286 195 382 315 l 473 568 b 116 35 293 437 116 266 m 675 -262 b 822 -52 770 -221 822 -150 l 822 -36 b 602 171 816 80 717 171 l 596 171 b 675 -262 626 14 652 -137 "},Vex.Flow.Font.glyphs.noteheadDoubleWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -328 b 724 -350 746 -339 736 -350 b 701 -328 711 -350 701 -339 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "},Vex.Flow.Font.glyphs.noteheadQuadWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -1428 b 724 -1450 746 -1439 736 -1450 b 701 -1428 711 -1450 701 -1439 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "},Vex.Flow.Font.glyphs.restDoubleWhole={x_min:0,x_max:640,ha:202,o:"0 0 133 0 1 1 640 640 2 -2 0 -1280 m 200 24 b 173 0 200 11 189 0 l 26 0 b 0 24 11 0 0 11 l 0 376 b 26 400 0 389 11 400 l 173 400 b 200 376 189 400 200 389 l 200 24 "},Vex.Flow.clefProperties.values.octave={line_shift:3.5},Vex.Flow.Clef.types.octave={code:"gClef8vb",point:40,line:3},Vex.Flow.Clef.types.treble={code:"gClef",point:40,line:3},Vex.Flow.Curve.prototype.renderCurve=function(a){var b=this.context,c=this.render_options.cps,d=this.render_options.x_shift,e=this.render_options.y_shift*a.direction,f=this.render_options.y_shift_start||0,g=this.render_options.y_shift_end||0,h=a.first_x+d,i=a.first_y+e+f,j=a.last_x-d,k=a.last_y+e+g,l=this.render_options.thickness,m=(j-h)/(c.length+2);
b.beginPath(),b.moveTo(h,i),b.bezierCurveTo(h+m+c[0].x,i+c[0].y*a.direction,j-m+c[1].x,k+c[1].y*a.direction,j,k),b.bezierCurveTo(j-m+c[1].x,k+(c[1].y+l)*a.direction,h+m+c[0].x,i+(c[0].y+l)*a.direction,h,i),b.stroke(),b.closePath(),b.fill()},Vex.Flow.Annotation=function(){function a(a){arguments.length>0&&this.init(a)}function b(){a.DEBUG&&Vex.L("Vex.Flow.Annotation",arguments)}a.Justify={LEFT:1,CENTER:2,RIGHT:3,CENTER_STEM:4},a.VerticalJustify={TOP:1,CENTER:2,BOTTOM:3,CENTER_STEM:4};var c=Vex.Flow.Modifier;return Vex.Inherit(a,c,{init:function(b){a.superclass.init.call(this),this.note=null,this.index=null,this.text_line=0,this.text=b,this.justification=a.Justify.CENTER,this.vert_justification=a.VerticalJustify.TOP,this.font={family:"Arial",size:10,weight:""},this.setWidth(Vex.Flow.textWidth(b))},getCategory:function(){return"annotations"},setTextLine:function(a){return this.text_line=a,this},setFont:function(a,b,c){return this.font={family:a,size:b,weight:c},this},setVerticalJustification:function(a){return this.vert_justification=a,this},getJustification:function(){return this.justification},setJustification:function(a){return this.justification=a,this},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw text annotation without a context.");if(!this.note)throw new Vex.RERR("NoNoteForAnnotation","Can't draw text annotation without an attached note.");var d=this.note.getModifierStartXY(c.Position.ABOVE,this.index);this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.weight);var e,f,g=this.context.measureText(this.text).width,h=this.context.measureText("M").width;e=this.justification==a.Justify.LEFT?d.x:this.justification==a.Justify.RIGHT?d.x-g:this.justification==a.Justify.CENTER?d.x-g/2:this.note.getStemX()-g/2;var i,j,k=this.note.hasStem(),l=this.note.getStave();if(k&&(i=this.note.getStemExtents(),j=l.getSpacingBetweenLines()),this.vert_justification==a.VerticalJustify.BOTTOM){if(f=l.getYForBottomText(this.text_line),k){var m=1===this.note.getStemDirection()?i.baseY:i.topY;f=Math.max(f,m+j*(this.text_line+2))}}else if(this.vert_justification==a.VerticalJustify.CENTER){var n=this.note.getYForTopText(this.text_line)-1,o=l.getYForBottomText(this.text_line);f=n+(o-n)/2+h/2}else if(this.vert_justification==a.VerticalJustify.TOP)f=Math.min(l.getYForTopText(this.text_line),this.note.getYs()[0]-10),k&&(f=Math.min(f,i.topY-5-j*this.text_line));else{var p=this.note.getStemExtents();f=p.topY+(p.baseY-p.topY)/2+h/2}this.x=e,this.y=f,this.text_height=h,this.text_width=g,b("Rendering annotation: ",this.text,e,f),this.context.fillText(this.text,e,f),this.context.restore()}}),a}(),Vex.Flow.StaveTie=function(){function a(a,b){arguments.length>0&&this.init(a,b)}return a.prototype={init:function(a,b){this.notes=a,this.context=null,this.text=b,this.render_options={cp1:8,cp2:12,text_shift_x:0,first_x_shift:0,last_x_shift:0,y_shift:7,tie_spacing:0,font:{family:"Arial",size:10,style:""}},this.font=this.render_options.font,this.setNotes(a)},setContext:function(a){return this.context=a,this},setFont:function(a){return this.font=a,this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Tie needs to have either first_note or last_note set.");if(a.first_indices||(a.first_indices=[0]),a.last_indices||(a.last_indices=[0]),a.first_indices.length!=a.last_indices.length)throw new Vex.RuntimeError("BadArguments","Tied notes must have similar index sizes");return this.first_note=a.first_note,this.first_indices=a.first_indices,this.last_note=a.last_note,this.last_indices=a.last_indices,this},isPartial:function(){return!this.first_note||!this.last_note},setDir:function(a){this.curvedir=a},getDir:function(){return this.curvedir},renderTie:function(a){if(0===a.first_ys.length||0===a.last_ys.length)throw new Vex.RERR("BadArguments","No Y-values to render");this.curvedir?a.direction="above"===this.curvedir?-1:1:this.curvedir=a.direction;var b=this.context,c=this.render_options.cp1,d=this.render_options.cp2;Math.abs(a.last_x_px-a.first_x_px)<10&&(c=2,d=8);for(var e=this.render_options.first_x_shift,f=this.render_options.last_x_shift,g=this.render_options.y_shift*a.direction,h=0;h<this.first_indices.length;++h){var i=(a.last_x_px+f+(a.first_x_px+e))/2,j=a.first_ys[this.first_indices[h]]+g,k=a.last_ys[this.last_indices[h]]+g;if(isNaN(j)||isNaN(k))throw new Vex.RERR("BadArguments","Bad indices for tie rendering.");var l=(j+k)/2+c*a.direction,m=(j+k)/2+d*a.direction;b.beginPath(),b.moveTo(a.first_x_px+e,j),b.quadraticCurveTo(i,l,a.last_x_px+f,k),b.quadraticCurveTo(i,m,a.first_x_px+e,j),b.closePath(),b.fill()}},renderText:function(a,b){if(this.text){var c=(a+b)/2;c-=this.context.measureText(this.text).width/2,this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.style),this.context.fillText(this.text,c+this.render_options.text_shift_x,(this.first_note||this.last_note).getStave().getYForTopText()-1),this.context.restore()}},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var a,b,c,d,e,f=this.first_note,g=this.last_note;return f?(a=f.getTieRightX()+this.render_options.tie_spacing,e=f.getStemDirection(),c=f.getYs()):(a=g.getStave().getTieStartX(),c=g.getYs(),this.first_indices=this.last_indices),g?(b=g.getTieLeftX()+this.render_options.tie_spacing,e=g.getStemDirection(),d=g.getYs()):(b=f.getStave().getTieEndX(),d=f.getYs(),this.last_indices=this.first_indices),this.renderTie({first_x_px:a,last_x_px:b,first_ys:c,last_ys:d,direction:e}),this.renderText(a,b),!0}},a}();var MEI2VF=function(a,b,c,d){return a.Util={attsToObj:function(a){var b,c;if(a.attributes)for(c={},b=a.attributes.length;b--;)c[a.attributes[b].nodeName]=a.attributes[b].nodeValue;return c},attsToString:function(a){var b,c,d,e,f="";for(d=a.attributes,b=0,c=d.length;c>b;b+=1)e=d.item(b),f+=" "+e.nodeName+'="'+e.nodeValue+'"';return f},drawBoundingBoxes:function(a,b){var c,e,f,g,h,i,j,k=this;if(b=b||{},a.save(),b.staffs&&b.staffs.data)for(c=0,e=b.staffs.data.length;e>c;c+=1)if(h=b.staffs.data[c])for(f=0,g=h.length;g>f;f+=1)h[f]&&(i=h[f],h[f].getBoundingBox().draw(a),j={x:i.getNoteStartX(),y:i.getYForLine(0)-30,w:i.getNoteEndX()-i.getNoteStartX(),h:i.getYForLine(4)-i.getYForLine(0)+60},k.drawRectangle(j,"120, 80, 200",a,b.frame),j={x:i.x,y:i.getYForLine(0)-30,w:i.getModifierXShift(),h:i.getYForLine(4)-i.getYForLine(0)+60},k.drawRectangle(j,"100, 100, 0",a,b.frame));b.voices&&b.voices.data&&d.each(b.voices.data,function(){this&&this.all_voices&&d.each(this.all_voices,function(){this&&this.voice&&(this.voice.boundingBox&&b.voices.drawFrame&&this.voice.getBoundingBox().draw(a),b.voices.drawTickables&&d.each(this.voice.tickables,function(){this.getBoundingBox().draw(a)}))})}),a.restore()},drawRectangle:function(a,b,c,d){d&&(c.strokeStyle="rgba("+b+", 0.5)",c.rect(a.x,a.y,a.w,a.h)),c.fillStyle="rgba("+b+", 0.1)",c.fillRect(a.x,a.y,a.w,a.h),c.stroke()}},a}(MEI2VF||{},MeiLib,Vex.Flow,jQuery),MEI2VF=function(a){return{setLogging:a.setLogging,Converter:{initConfig:function(b){return a.Converter.prototype.initConfig(b)},process:function(b){return a.Converter.prototype.process(b)},draw:function(b){return a.Converter.prototype.draw(b)},getAllVexMeasureStaffs:function(){return a.Converter.prototype.getAllVexMeasureStaffs()},getStaffArea:function(){return a.Converter.prototype.getStaffArea()}}}}(MEI2VF||{},MeiLib,Vex.Flow,jQuery);MEI2VF.rendered_measures=null,MEI2VF.render_notation=function(a,b,c,d,e,f){var g,h=f||{};g=new Vex.Flow.Renderer(b,e||Vex.Flow.Renderer.Backends.CANVAS).getContext(),c=c||800,d=d||350,+e===Vex.Flow.Renderer.Backends.RAPHAEL&&g.paper.setSize(c,d),h.page_width=c,this.Converter.initConfig(h),this.Converter.process(a[0]||a),this.Converter.draw(g),this.rendered_measures=this.Converter.getAllVexMeasureStaffs()};