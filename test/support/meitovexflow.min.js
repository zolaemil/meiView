/*! meitovexflow 2014-03-29 */
var MeiLib={};MeiLib.RuntimeError=function(a,b){this.errorcode=a,this.message=b},MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""},MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)},MeiLib.EventEnumerator=function(a){this.init(a)},MeiLib.EventEnumerator.prototype.init=function(a){if(!a)throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");this.node=a,this.next_evnt=null,this.EoI=!0,this.children=$(this.node).children(),this.i_next=-1,this.read_ahead()},MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;return this.read_ahead(),a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")},MeiLib.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()},MeiLib.EventEnumerator.prototype.step_ahead=function(){if(++this.i_next,this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=$(this.next_evnt).prop("localName");"note"===a||"rest"===a||"mRest"===a||"chord"===a?this.EoI=!1:"beam"===a&&(this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1))}else this.EoI=!0},MeiLib.durationOf=function(a,b){IsSimpleEvent=function(a){return"note"===a||"rest"===a||"space"===a};var c=function(a,b){var c=$(a).attr("dur");if(!c)throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note>, <rest> or <space> must be specified.");return MeiLib.dotsMult(a)*MeiLib.dur2beats(Number(c),b)},d=function(a,b,c){c||(c="1");var d=$(a).attr("dur"),e=MeiLib.dotsMult(a);if(d)return e*MeiLib.dur2beats(Number(d),b);if($(a).find("note").each(function(){if(lyr_n=$(this).attr("layer"),!lyr_n||lyr_n===c){var b=$(this).attr("dur"),f=MeiLib.dotsMult(a);if(!d&&b)d=b,e=f;else if(d&&d!=b)throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}),d)return e*MeiLib.dur2beats(Number(d),b);throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")},e=function(a,b){var e=0;return a.children().each(function(){var a,f=this.prop("localName");if(IsSimpleEvent(f))a=c(this,b);else{if("chord"!==f)throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+f+"'");a=d(this,b)}e+=a}),e},f=$(a).prop("localName");if(IsSimpleEvent(f))return c(a,b);if("mRest"===f)return b.count;if("chord"===f)return d(a,b);if("beam"===f)return e(a,b);throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+f+"'")},MeiLib.tstamp2id=function(a,b,c){for(var d,e,f,g,h=Number(a),i=0,j=function(){return i+1},k=function(){return h-j()},l=new MeiLib.EventEnumerator(b);!l.EoI&&(void 0===e||e>0);)f=d,g=e,d=l.nextEvent(),e=k(),i+=MeiLib.durationOf(d,c);if(void 0===e)return void 0;var m;m=0>e&&f&&g<Math.abs(e)?f:d;var n;return n=$(m).attr("xml:id"),n||(n=MeiLib.createPseudoUUID(),$(m).attr("xml:id",n)),n},MeiLib.XMLID=function(a){return xml_id=$(a).attr("xml:id"),xml_id||(xml_id=MeiLib.createPseudoUUID(),$(a).attr("xml:id",xml_id)),xml_id},MeiLib.id2tstamp=function(a,b){for(var c,d=!1,e=0;e<b.length&&!d;++e){if(b[e].meter&&(c=b[e].meter),0===e&&!c)throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var f=MeiLib.sumUpUntil(a,b[e].layer,c);if(f.found)return d=!0,e.toString()+"m+"+(f.beats+1).toString()}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+a+'" was found in the given MEI context.')},MeiLib.dur2beats=function(a,b){return b.unit/a},MeiLib.beats2dur=function(a,b){return b.unit/a},MeiLib.dotsMult=function(a){var b=$(a).attr("dots");b=Number(b||"0");for(var c=1;b>0;--b)c+=1/Math.pow(2,b);return c},MeiLib.sumUpUntil=function(a,b,c){var d=function(b){var e=$(b),f=e.prop("localName");if("note"===f||"rest"===f){if(e.attr("xml:id")===a)return{beats:0,found:!0};var g=Number(e.attr("dur"));if(!g)throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");var h=e.attr("dots");h=Number(h||"0");var i=MeiLib.dotsMult(e)*MeiLib.dur2beats(g,c);return{beats:i,found:!1}}if("mRest"===f)return e.attr("xml:id")===a?(k=!0,{beats:0,found:!0}):{beats:c.count,found:!1};if("layer"===f||"beam"===f){for(var i=0,j=e.children(),k=!1,l=0;l<j.length&&!k;++l){var m=d(j[l]);i+=m.beats,k=m.found}return{beats:i,found:k}}if("chord"===f){var n=e.attr("dur");if(e.attr("xml:id")===a)return{beats:0,found:!0};var n=e.attr("dur");if(n)return e.find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:MeiLib.dur2beats(n,c),found:k};for(var j=e.children(),k=!1,l=0;l<j.length&&!k;++l){var m=d(j[l]);i=m.beats,k=m.found}return{beats:i,found:k}}return{beats:0,found:!1}};return d(b)},MeiLib.SliceMEI=function(a,b){var c=function(a,b){$.each(a,function(a,c){b.noClef&&$(c).attr("clef.visible","false"),b.noKey&&$(c).attr("key.sig.show","false"),b.noMeter&&$(c).attr("meter.rend","false")})},d=b.staves;if(d)for(var e="",f="",g="",h=0;h<d.length;h++)e+=g+'[n="'+d[h]+'"]',f+=g+'[staff="'+d[h]+'"]',0===h&&(g=", ");var i,j=a.cloneNode(!0);if(d&&$(j).find("staffDef").remove(":not("+e+")"),b.noClef||b.noKey||b.noMeter){var k=$(j).find("staffDef"),i=$(j).find("scoreDef");c(i,b),c(k,b)}b.noConnectors&&$(j).find("staffGrp").removeAttr("symbol");var l=$(j).find("section")[0],m=!1,n=!1,o=l.childNodes;return $(o).each(function(){var a=this;if(m||("measure"===a.localName&&Number($(a).attr("n"))===b.start_n?(m=!0,n=!0):l.removeChild(a)),m){if(d){$(a).find("[staff]").remove(":not("+f+")");var c=$(a).find("staff");$(c).each(function(){var a=this;if(-1===$.inArray(Number($(a).attr("n")),d)){var b=this.parentNode;b.removeChild(this)}})}"measure"===a.localName&&Number($(a).attr("n"))===b.end_n&&(m=!1)}}),j},MeiLib.Alt=function(a,b){this.xmlID=a,this.altitems=[],this.parentID=b},MeiLib.Variant=function(a,b,c,d,e){this.xmlID=a,this.tagname=b,this.source=c,this.resp=d,this.n=e},MeiLib.MeiDoc=function(a){a&&this.init(a)},MeiLib.MeiDoc.prototype.init=function(a){this.xmlDoc=a,this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0],this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0],this.rich_score=$(this.rich_music).find("score")[0],this.parseSourceList(),this.parseEditorList(),this.parseALTs(),this.initAltgroups(),this.initSectionView()},MeiLib.MeiDoc.prototype.getRichScore=function(){return this.rich_score},MeiLib.MeiDoc.prototype.getPlainScore=function(){return this.plain_score},MeiLib.MeiDoc.prototype.getALTs=function(){return this.ALTs},MeiLib.MeiDoc.prototype.getSourceList=function(){return this.sourceList},MeiLib.MeiDoc.prototype.getEditorList=function(){return this.editorList},MeiLib.MeiDoc.prototype.parseSourceList=function(){return this.sources=$(this.rich_head).find("sourceDesc").children(),this.sources},MeiLib.MeiDoc.prototype.parseEditorList=function(){return this.editors=$(this.rich_head).find("titleStmt").children("editor"),this.editors},MeiLib.MeiDoc.prototype.parseALTs=function(){this.ALTs={};for(var a=$(this.rich_score).find("app, choice"),b=0;b<a.length;b++){var c=a[b],d=c.parentNode,e=$(c).find("rdg, lem, sic, corr"),f=new MeiLib.Alt(MeiLib.XMLID(c),MeiLib.XMLID(d));f.altitems={};for(var g=0;g<e.length;g++){var h=e[g],i=$(h).attr("source"),j=$(h).attr("resp"),k=$(h).attr("n"),l=$(h).prop("localName"),m=MeiLib.XMLID(h);f.altitems[m]=new MeiLib.Variant(m,l,i,j,k)}this.ALTs[MeiLib.XMLID(c)]=f}},MeiLib.MeiDoc.prototype.initAltgroups=function(){this.ALTs;annots=$(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]'),this.altgroups={};for(var a=0;a<annots.length;a++){altgroup=[],token_list=$(annots[a]).attr("plist").split(" ");for(var b=0;b<token_list.length;b++)altgroup.push(token_list[b].replace("#",""));for(var b in altgroup)this.altgroups[altgroup[b]]=altgroup}},MeiLib.MeiDoc.prototype.initSectionView=function(a){a=a||{},this.sectionview_score=this.rich_score.cloneNode(!0),this.sectionplane={};var b,c,d=$(this.sectionview_score).find("app, choice"),e=(this.sectionview_score,this.sectionplane),f=this.ALTs,g=this.xmlDoc;return $(d).each(function(d,h){var i=MeiLib.XMLID(h),j=a[i];if(j){c=j.xmlID;var k=$(this_score).find(j.tagname+'[xml\\:id="'+c+'"]')[0];if(!k)throw new MeiLib.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+c+"'.");b=k.childNodes}else if("choice"===h.localName){var l=$(h).find("corr")[0];if(l)c=MeiLib.XMLID(l),b=l.childNodes;else{var m=$(h).find("sic")[0];m?(c=MeiLib.XMLID(m),b=m.childNodes):b=[]}}else{var n=$(h).find("lem")[0];n?(c=MeiLib.XMLID(n),b=n.childNodes):b=[]}var o=h.parentNode,p=g.createProcessingInstruction("MEI2VF",'rdgStart="'+i+'"');o.insertBefore(p,h),$.each(b,function(){o.insertBefore(this.cloneNode(!0),h)});var q=g.createProcessingInstruction("MEI2VF",'rdgEnd="'+i+'"');o.insertBefore(q,h),o.removeChild(h),e[i]=f[i].altitems[c]}),this.sectionview_score},MeiLib.MeiDoc.prototype.updateSectionView=function(a){var b=function(a,b){var c,d=function(a,b){var c=0;for(var d in a)void 0!==a[d]&&a[d]===b[d]&&c++;return console.log("vars_match: "+c),c},e=0;for(var f in a)M=d(a[f],b),M>e&&(e=M,c=a[f]);return c};for(altID in a){var c=this.ALTs[altID].altitems[a[altID]];if(altgroup=this.altgroups[altID]){var d;for(d=0;d<altgroup.length;d++)altID__=altgroup[d],alt_instance2insert__=b(this.ALTs[altID__].altitems,c),this.replaceAltInstance({appXmlID:altID__,replaceWith:alt_instance2insert__})}else this.replaceAltInstance({appXmlID:altID,replaceWith:c})}},MeiLib.MeiDoc.prototype.replaceAltInstance=function(a){var b=a.appXmlID,c=[];if(a.replaceWith){var d=a.replaceWith.xmlID,e=$(this.rich_score).find(a.replaceWith.tagname+'[xml\\:id="'+d+'"]')[0];c=e.childNodes}var f=function(a,b){return a=a.replace("'",'"'),b=b.replace("'",'"'),a===b},g=$(this.sectionview_score).find("[xml\\:id="+this.ALTs[b].parentID+"]")[0],h=g.childNodes,i=!1,j=!1,k=null;if($(h).each(function(){var a=this;7===a.nodeType?"MEI2VF"===a.nodeName&&f(a.nodeValue,'rdgStart="'+b+'"')?(i=!0,j=!0):"MEI2VF"===a.nodeName&&f(a.nodeValue,'rdgEnd="'+b+'"')&&(i=!1,k=a):i&&g.removeChild(a)}),!j)throw"processing instruction not found";if(i)throw"Unmatched <?MEI2VF rdgStart?>";var l;return l=k?function(a){g.insertBefore(a,k)}:function(a){g.appendChild(a)},$.each(c,function(){l(this.cloneNode(!0))}),this.sectionplane[b]=a.replaceWith,this.sectionview_score},MeiLib.MeiDoc.prototype.getSectionViewSlice=function(a){return MeiLib.SliceMEI(this.sectionview_score,a)},MeiLib.MeiDoc.prototype.getRichSlice=function(a){var b=new MeiLib.MeiDoc;return b.xmlDoc=this.xmlDoc,b.rich_head=this.rich_head.cloneNode(!0),b.rich_music=this.rich_music.cloneNode(!0),b.rich_score=MeiLib.SliceMEI(this.rich_score,a),b.sourceList=this.sourceList,b.editorList=this.editorList,b.ALTs=this.ALTs,b.altgroups=this.altgroups,b};var MEI2VF=function(a,b){return a.tables={positions:{above:b.Modifier.Position.ABOVE,below:b.Modifier.Position.BELOW},hairpins:{cres:b.StaveHairpin.type.CRESC,dim:b.StaveHairpin.type.DECRESC},articulations:{acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},barlines:{single:b.Barline.type.SINGLE,dbl:b.Barline.type.DOUBLE,end:b.Barline.type.END,rptstart:b.Barline.type.REPEAT_BEGIN,rptend:b.Barline.type.REPEAT_END,rptboth:b.Barline.type.REPEAT_BOTH,invis:b.Barline.type.NONE}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Renderer=function(a){return a&&this.initConfig(a).process().draw(),this},a.Renderer.prototype={STAVE_HEIGHT:40,HALF_LINE_DISTANCE:5,initConfig:function(a){return this.cfg=a,this},process:function(a){var b,d=this;return b=a||d.cfg.xmlDoc,d.reset(),d.processScoreDef(c(b).find("scoreDef")[0]),d.processSections(b),d.ties.createVexFromLinks(d.notes_by_id),d.slurs.createVexFromLinks(d.notes_by_id),d.hairpins.createVexFromLinks(d.notes_by_id),d},draw:function(){var a=this,b=a.cfg.ctx;return a.drawVexStaffs(a.allVexMeasureStaffs,b),a.startConnectors.setContext(b).draw(),a.inlineConnectors.setContext(b).draw(),a.drawVexVoices(a.allStaffVoices,b),a.drawVexBeams(a.allBeams,b),a.ties.setContext(b).draw(),a.slurs.setContext(b).draw(),a.hairpins.setContext(b).draw(),a.texts.setContext(b).draw(),a.drawAnchoredTexts(a.allAnchoredTexts,a.HALF_LINE_DISTANCE,b),a.hyphenation.setContext(b).draw(),a},reset:function(){var b=this;return b.allVexMeasureStaffs=[],b.allStaffVoices=[],b.allAnchoredTexts=[],b.allBeams=[],b.texts=new a.Texts,b.startConnectors=new a.Connectors(b.cfg.labelScheme),b.inlineConnectors=new a.Connectors,b.ties=new a.Ties,b.slurs=new a.Ties,b.hairpins=new a.Hairpins,b.hyphenation=new a.Hyphenation(b.cfg),b.notes_by_id={},b.currentSystem=0,b.currentSystemMarginLeft=b.cfg.systemLeftMar,b.pendingSystemBreak=!1,b.pendingSectionBreak=!0,b.currentLowestY=0,b.currentVoltaType=null,b.unresolvedTStamp2=[],b.currentStaffInfos=[],b.directionsInCurrentMeasure=[],b},processScoreDef:function(a){var b,d,e,f,g=this;for(f=c(a).attr("system.leftmar"),"string"==typeof f&&(g.currentSystemMarginLeft=+f),e=c(a).children(),b=0,d=e.length;d>b;b+=1)g.processScoreDef_child(e[b])},processScoreDef_child:function(b){var c=this;switch(b.localName){case"staffGrp":c.processStaffGrp(b);break;case"pgHead":c.processPgHead(b);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <scoreDef>")}},processPgHead:function(a){var b=this;b.texts.addComplexText(a,{x:b.cfg.page_margin_left,y:200,w:b.cfg.printSpaceWidth})},processStaffGrp:function(a,b){var d=this,e={};return c(a).children().each(function(a,b){var c=d.processStaffGrp_child(b);Vex.LogDebug("processStaffGrp() {1}.{a}: childRange.first_n:"+c.first_n+" childRange.last_n:"+c.last_n),0===a&&(e.first_n=c.first_n),e.last_n=c.last_n}),d.setConnectorModels(a,e,b),e},setConnectorModels:function(a,b,d){var e,f,g,h,i=this;g=b.first_n,h=b.last_n,e=c(a).attr("symbol"),f=c(a).attr("barthru"),Vex.LogDebug("setConnectorModels() {2}: symbol:"+e+" range.first_n:"+g+" range.last_n:"+h),i.startConnectors.setModelForStaveRange({top_staff_n:g,bottom_staff_n:h,symbol:e||"line",label:c(a).attr("label"),labelAbbr:c(a).attr("label.abbr")}),!d&&i.cfg.autoStaveConnectorLine&&i.startConnectors.setModelForStaveRange({top_staff_n:g,bottom_staff_n:h,symbol:"none"===e?"none":"line"},"autoline"),"true"===f&&i.inlineConnectors.setModelForStaveRange({top_staff_n:g,bottom_staff_n:h,symbol:"singleright"})},processStaffGrp_child:function(b){var c,d=this;switch(b.localName){case"staffDef":return c=d.processStaffDef(b),{first_n:c,last_n:c};case"staffGrp":return d.processStaffGrp(b,!0);default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <staffGrp>")}},processStaffDef:function(b){var d,e,f=this;return d=+c(b).attr("n"),e=f.currentStaffInfos[d],e?e.updateDef(b):f.currentStaffInfos[d]=new a.StaffInfo(b,!0,!0,!0),d},startSystem:function(a){var b,c,d=this;for(Vex.LogDebug("me.startSystem() {enter}"),d.pendingSystemBreak=!1,d.currentSystem+=1,d.initStaffYs(),d.currentMeasureX=d.cfg.page_margin_left+d.currentSystemMarginLeft,d.measureWidthsInSystem=d.getMeasureWidths(a),d.pendingSectionBreak?(d.pendingSectionBreak=!1,c="forceSectionStartInfo"):c="forceStaveStartInfo",b=d.currentStaffInfos.length;b--;)d.currentStaffInfos[b]&&d.currentStaffInfos[b][c]()},initStaffYs:function(){var a,b,c,d,e,f=this,g=!0;for(a=1===f.currentSystem?f.cfg.page_margin_top:f.currentLowestY+f.cfg.systemSpacing,b=0,d=1,e=f.currentStaffInfos.length;e>d;d+=1)f.currentStaffInfos[d]&&(b+=g?0:f.currentStaffInfos[d].spacing||f.STAVE_HEIGHT+f.cfg.staveSpacing,f.currentStaffInfos[d].absoluteY=a+b,g=!1);c=a+b+f.STAVE_HEIGHT,c>f.currentLowestY&&(f.currentLowestY=c)},getMeasureWidths:function(a){var b,c=this;return b=c.addMissingMeasureWidths(c.getMEIWidthsTillSb(a)),Vex.LogDebug("me.getMeasureWidths(): #"+b.length),b},getMEIWidthsTillSb:function(a){var b=this,c=a,d=[];for(Vex.Log("me.getMEIWidthsTillSb() {}");c;){switch(c.localName){case"measure":d.push(Math.floor(+c.getAttribute("width"))||null);break;case"sb":return d}c=b.getNext(c)}return d},getNext:function(a){var b,c,d=this;return(c=d.getNextElement(a))?c:(b=a.parentNode,c=d.getNextElement(b),c?c.firstChild:void 0)},getNextElement:function(a){var b=a;do b=b.nextSibling;while(b&&1!=b.nodeType);return b},addMissingMeasureWidths:function(a){var b,c,d,e=this,f=0,g=0;for(b=0,c=a.length;c>b;b+=1)null===a[b]?g+=1:f+=a[b];for(d=Math.floor((e.cfg.printSpaceWidth-e.currentSystemMarginLeft-f)/g),b=0,c=a.length;c>b;b+=1)null===a[b]&&(a[b]=d);return a},setNewMeasureX:function(){var a,b=this;a=b.allVexMeasureStaffs[b.allVexMeasureStaffs.length-1][1],a?(b.currentMeasureX=a.x+a.width,Vex.LogDebug("setNewMeasureX(): currentMeasureX:"+b.currentMeasureX)):(b.currentMeasureX=b.cfg.page_margin_left+b.currentSystemMarginLeft,Vex.LogDebug("setNewMeasureX(): NO PREVIOUS MEASURE FOUND (!)"))},processSections:function(a){var b=this;c(a).find("section, ending").each(function(a,c){"ending"===c.localName?b.processEnding(c):b.processSection(c)})},processSection:function(a){var b,d,e=this,f=c(a).children();for(b=0,d=f.length;d>b;b+=1)e.processSectionChild(f[b])},processEnding:function(a){var b,d,e=this,f=c(a).children();for(b=0,d=f.length;d>b;b+=1)e.currentVoltaType={},0===b&&(e.currentVoltaType.start=c(a).attr("n")),b===d-1&&(e.currentVoltaType.end="1"),e.processSectionChild(f[b]);e.currentVoltaType=null},processSectionChild:function(b){var c=this;switch(b.localName){case"measure":c.processMeasure(b);break;case"scoreDef":c.processScoreDef(b);break;case"staffDef":c.processStaffDef(b);break;case"sb":c.setPendingSystemBreak(b);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <section>")}},setPendingSystemBreak:function(){this.pendingSystemBreak=!0},processMeasure:function(b){var d,e,f,g,h,i,j=this,k=!0;j.pendingSectionBreak||j.pendingSystemBreak?(j.startSystem(b),e=!0,j.hyphenation.addLineBreaks(j.currentStaffInfos,j.currentMeasureX)):(j.setNewMeasureX(),e=!1),i=j.measureWidthsInSystem.shift(),Vex.LogDebug("me.processMeasure() {enter}, currentMeasureWidth: "+i),h=new a.StaveVoices,d=+c(b).attr("n"),f=b.getAttribute("left"),g=b.getAttribute("right"),j.directionsInCurrentMeasure=j.getDirectionsInElement(b),c(b).find("staff").each(function(){j.processStaffInMeasure(this,d,f,g,e,k,h,i),k=!1}),j.allStaffVoices.push({staveVoices:h,measureStaffs:j.allVexMeasureStaffs[d]}),e&&j.startConnectors.createVexFromModels(j.allVexMeasureStaffs[d],null,null,j.currentSystem),j.inlineConnectors.createVexFromModels(j.allVexMeasureStaffs[d],f,g),j.extract_linkingElements(b,"tie",j.ties),j.extract_linkingElements(b,"slur",j.slurs),j.extract_linkingElements(b,"hairpin",j.hairpins),j.extract_tempoElements(b,j.allVexMeasureStaffs[d])},extract_tempoElements:function(a,b){var d,e,f,g,h,i=this;c(a).find("tempo").each(function(a,j){d=c(j).attr("staff"),ho=c(j).attr("ho"),vo=c(j).attr("vo"),e=b[d],f=c(j).text(),h=new Vex.Flow.StaveTempo({name:f,duration:c(j).attr("mm.unit"),dots:+c(j).attr("mm.dots"),bpm:+c(j).attr("mm")},e.x,5),vo&&h.setShiftY(+vo*i.HALF_LINE_DISTANCE),g=e.getModifierXShift()>0?-14:14,e.hasTimeSignature&&(g-=24),ho&&(g+=+ho*i.HALF_LINE_DISTANCE),h.setShiftX(g),h.font=i.cfg.tempoFont,e.modifiers.push(h)})},processStaffInMeasure:function(a,b,e,f,g,h,i,j){var k,l,m,n,o,p,q=this;l=+c(a).attr("n"),k=q.createVexStaff(b,l,e,f,j,g,h),q.allVexMeasureStaffs[b]===d&&(q.allVexMeasureStaffs[b]=[]),q.allVexMeasureStaffs[b][l]=k,n=c(a).children("anchoredText").each(function(a,b){q.processAnchoredStaffText(b,k)}),m=c(a).find("layer"),o=function(a,c){var d=q.processElement(c,this,b,l,k);return d.vexNote||d},c.each(m,function(a,d){q.resolveUnresolvedTimestamps(d,l,b),p=c(d).children().map(o).get(),i.addVoice(q.createVexVoice(p,l),l)})},createVexStaff:function(c,d,e,f,g,h,i){var j,k,l=this;if(!d)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".');return k=l.currentStaffInfos[d],j=new b.Stave(l.currentMeasureX,k.absoluteY,g,l.cfg.staff),j.options.bottom_text_position=l.cfg.staff.bottom_text_position,j.font=l.cfg.staffFont,k.showClefCheck()&&j.addClef(k.getClef()),k.showKeysigCheck()&&j.addKeySignature(k.getKeySpec()),k.showTimesigCheck()&&(j.addTimeSignature(k.getTimeSig()),j.hasTimeSignature=!0),j.setBegBarType(e?a.tables.barlines[e]:b.Barline.type.NONE),f&&j.setEndBarType(a.tables.barlines[f]),i&&(h&&l.cfg.autoMeasureNumbers&&1!==c&&j.setMeasure(c),l.currentVoltaType&&l.addStaffVolta(j)),h&&l.addStaffLabel(j,d),j},addStaffVolta:function(a){var b=this.currentVoltaType;b.start&&a.setVoltaType(Vex.Flow.Volta.type.BEGIN,b.start+".",30,0),b.end&&a.setVoltaType(Vex.Flow.Volta.type.END,"",30,0),b.start||b.end||a.setVoltaType(Vex.Flow.Volta.type.MID,"",30,0)},addStaffLabel:function(b,c){var d,e=this;switch(e.cfg.labelScheme){case a.CONST.LABELS_FULL:d=1===e.currentSystem?e.currentStaffInfos[c].label:e.currentStaffInfos[c].labelAbbr;break;case a.CONST.LABELS_ABBR:d=e.currentStaffInfos[c].labelAbbr;break;default:return}d&&b.setText(d,Vex.Flow.Modifier.Position.LEFT,{shift_y:-3})},createVexVoice:function(d,e){var f,g,h=this;if(!c.isArray(d))throw new a.RUNTIME_ERROR("BadArguments","me.createVexVoice() voice_contents argument must be an array.");return g=h.currentStaffInfos[e].meter,f=new b.Voice({num_beats:g.count,beat_value:g.unit,resolution:b.RESOLUTION}),f.setStrict(!1),f.addTickables(d),f},processAnchoredStaffText:function(a,b){var d=this,e=c(a);d.allAnchoredTexts.push({text:e.text(),container:b,x:e.attr("x"),y:e.attr("y"),ho:e.attr("ho"),vo:e.attr("vo")})},resolveUnresolvedTimestamps:function(b,d,e){var f,g=this;if(!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.me.extract_events:","<measure> must have @n specified");d=d||1,f=e+":"+d+":"+(c(b).attr("n")||"1"),g.unresolvedTStamp2[f]&&(c(g.unresolvedTStamp2[f]).each(function(a,c){c.setContext({layer:b,meter:g.currentStaffInfos[d].meter}),g.unresolvedTStamp2[f][a]=null}),g.unresolvedTStamp2[f]=null)},extract_linkingElements:function(b,d,e){var f=this,g=function(a){return{staff_n:c(a).attr("staff")||"1",layer_n:c(a).attr("layer")||"1"}},h=function(b,d,e){var h=g(d),i=c(e).find('staff[n="'+h.staff_n+'"]'),j=c(i).find('layer[n="'+h.layer_n+'"]').get(0);if(!j){var k=c(i).find("layer");if(k&&!k.attr("n")&&(j=k),!j)throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}var l=f.currentStaffInfos[h.staff_n];if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.");var m=l.meter;if(!m.count||!m.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");return MeiLib.tstamp2id(b,j,m)},i=function(a){return a.substring(0,a.indexOf("m"))},j=function(a){return a.substring(a.indexOf("+")+1)},k=c(b).find(d);c.each(k,function(k,l){var m,n,o,p,q,r,s;if(m=new a.EventLink(null,null),n=a.attsToObj(l),"hairpin"===d&&!n.form)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.");if(m.setParams(a.attsToObj(l)),o=n.startid,o?m.setFirstId(o):(p=n.tstamp,p&&(o=h(p,l,b),m.setFirstId(o))),q=n.endid)m.setLastId(q);else if(r=n.tstamp2)if(s=+i(r),s>0){m.setLastTStamp(j(r));var t=g(l),u=+c(b).attr("n")+s,v=u.toString()+":"+t.staff_n+":"+t.layer_n;f.unresolvedTStamp2[v]||(f.unresolvedTStamp2[v]=[]),f.unresolvedTStamp2[v].push(m)}else q=h(j(r),l,b),m.setLastId(q);e.add(m)})},processElement:function(b,c,d,e,f){var g=this;switch(b.localName){case"rest":return g.processRest(b,f,c,d,e);case"mRest":return g.processmRest(b,f,c,d,e);case"space":return g.processSpace(b,f,c,d,e);case"note":return g.processNote(b,f,c,d,e);case"beam":return g.processBeam(b,f,c,d,e);case"chord":return g.processChord(b,f,c,d,e);case"anchoredText":return g.processAnchoredText(b,f,c,d,e);default:throw new a.RUNTIME_ERROR("BadArguments",'Rendering of element "'+element_type+'" is not supported.')}},processAnchoredText:function(){},getClefForStaffNr:function(b){var c,d=this;if(c=d.currentStaffInfos[b],!c)throw new a.RUNTIME_ERROR("MEI2VF.getClefForStaffNr():E01","No staff definition for staff n="+b);return c.getClef()},processNote:function(d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t=this;q=a.attsToObj(d),i=+q.dots,mei_accid=q.accid,j=q.ho,k=q.pname,l=q.oct,n=q.tie,o=q.slur,note_staff_n=+q.staff||h,m=q["xml:id"],m||(m=MeiLib.createPseudoUUID(),c(d).attr("xml:id",m));try{if(r={keys:[t.processAttsPitch(d)],clef:t.getClefForStaffNr(h),duration:t.processAttsDuration(d)},t.setStemDir(d,r),s=new b.StaveNote(r),note_staff_n===h)s.setStave(e);else{var u=t.allVexMeasureStaffs[g][note_staff_n];if(!u)throw new a.RUNTIME_ERROR("Error",'Note has staff attribute "'+note_staff_n+'", but the staff does not exist.');s.setStave(u)}t.processSyllables(s,d,h),t.addDirections(s,m);try{for(p=0;i>p;p+=1)s.addDotToAll()}catch(v){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the dots of <note>: "+a.listAttrs(d))}if(mei_accid&&t.processAttrAccid(mei_accid,s,0),j&&t.processAttrHo(j,s),c.each(c(d).find("artic"),function(d,e){s.addArticulation(0,new b.Articulation(a.tables.articulations[c(e).attr("artic")]).setPosition(a.tables.positions[c(e).attr("place")]))}),c.each(c(d).children(),function(a,b){c(b).remove()}),!k)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute");if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute");return n&&t.processAttrTie(n,m,k,l,t.currentSystem),o&&t.processAttrSlur(o,m,k,l,t.currentSystem),t.notes_by_id[m]={meiNote:d,vexNote:s},{vexNote:s,id:m}}catch(w){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <note>: "+a.listAttrs(d)+"\nORIGINAL ERROR MESSAGE: "+w.toString())}},processChord:function(d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u=this,v=[],w=[];l=c(d).children(),atts=a.attsToObj(d),o=atts.dur,r=atts.ho;var p=atts["xml:id"];p||(p=MeiLib.createPseudoUUID(),c(d).attr("xml:id",p)),k=!!c(d).attr("dots");try{if(o)m=u.translateDuration(+o);else{for(i=0,j=l.length;j>i;i+=1)w.push(+l[i].getAttribute("dur"));m=u.translateDuration(Math.max.apply(Math,w))}for(i=0,j=l.length;j>i;i+=1)v.push(u.processAttsPitch(l[i])),"1"===l[i].getAttribute("dots")&&(k=!0);k&&(m+="d"),t={keys:v,clef:u.getClefForStaffNr(h),duration:m},u.setStemDir(d,t),s=new b.StaveNote(t),s.setStave(e);var x=[];return l.each(function(b,e){note_atts=a.attsToObj(e),x.push(b);var f=note_atts.tie,g=note_atts.slur,h=note_atts["xml:id"];h||(h=MeiLib.createPseudoUUID(),c(e).attr("xml:id",h)),f&&u.processAttrTie(f,h,note_atts.pname,note_atts.oct,u.currentSystem),q&&u.processAttrSlur(g,h,note_atts.pname,note_atts.oct,u.currentSystem),u.notes_by_id[h]={meiNote:d,vexNote:s,index:[b]},n=c(e).attr("accid"),n&&u.processAttrAccid(n,s,b)}),k&&s.addDotToAll(),r&&u.processAttrHo(r,s),u.notes_by_id[p]={meiNote:d,vexNote:s,index:x},s}catch(y){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <chord>:"+y.toString())}},processRest:function(d,e){var f,g,h,i,j=this;try{return f=j.processAttsDuration(d,!0),g=new b.StaveNote({keys:["w"===f?"d/5":"b/4"],duration:f+"r"}),i=c(d).attr("xml:id"),j.addDirections(g,i),h=c(d).attr("ho"),h&&j.processAttrHo(h,g),g.setStave(e),"1"===c(d).attr("dots")&&g.addDotToAll(),g}catch(k){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <rest>: "+a.listAttrs(d))}},processmRest:function(d,e){var f,g,h=this;try{return f=new b.StaveNote({keys:["d/5"],duration:"wr"}),g=c(d).attr("ho"),g&&h.processAttrHo(g,f),f.setStave(e),f}catch(i){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <mRest>: "+a.listAttrs(d))}},processSpace:function(c,d){var e,f=this;try{return e=new b.GhostNote({duration:f.processAttsDuration(c,!0)+"r"}),e.setStave(d),e}catch(g){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <space>: "+a.listAttrs(c))}},processBeam:function(a,d,e,f,g){var h,i=this;return h=c(a).children().map(function(a,b){var c=i.processElement(b,e,f,g,d);return c.vexNote||c}).get(),i.allBeams.push(new b.Beam(h)),h},accidentalMap:{n:"n",f:"b",s:"#",bb:"ff",ss:"##"},processAttrAccid:function(c,d,e){var f=this,g=f.accidentalMap[c];if(!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+c);d.addAccidental(e,new b.Accidental(g))},processAttrHo:function(a,b){var c=this;b.setExtraLeftPx(+a*c.HALF_LINE_DISTANCE)},processAttrTie:function(a,b,c,d,e){var f,g,h=this;for(f=0,g=a.length;g>f;++f)switch(a[f]){case"i":h.ties.start_tieslur(b,{pname:c,oct:d,system:e});break;case"t":h.ties.terminate_tie(b,{pname:c,oct:d,system:e})}},processAttrSlur:function(a,b,d,e,f){var g,h=this;a&&(g=h.parse_slur_attribute(a),c.each(g,function(a,c){switch(c.letter){case"i":h.slurs.start_tieslur(b,{nesting_level:c.nesting_level,system:f});break;case"t":h.slurs.terminate_slur(b,{nesting_level:c.nesting_level,system:f})}}))},parse_slur_attribute:function(b){var c,d,e,f,g,h=[];for(c=b.split(" "),e=0,f=c.length;f>e;e+=1)if(d=c[e],1===d.length)h.push({letter:d,nesting_level:0});else{if(2!==d.length)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");if(g=+d[1],!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");h.push({letter:d[0],nesting_level:g})}return h},processAttsPitch:function(b){var d,e;if(d=c(b).attr("pname"),e=c(b).attr("oct"),!d||!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>");return d+"/"+e},getDirectionsInElement:function(a){var b=this,d=[];return c(a).find("dir").each(function(){d.push({text:c(this).text().trim(),startid:b.getMandatoryAttr(this,"startid"),place:b.getMandatoryAttr(this,"place")})}),d},addDirections:function(a,b){for(var c,d=this,e=d.directionsInCurrentMeasure.length;e--;)c=d.directionsInCurrentMeasure[e],c.startid===b&&a.addAnnotation(2,"below"===c.place?d.createAnnot(c.text,d.cfg.annotFont).setBottom(!0):d.createAnnot(c.text,d.cfg.annotFont))},processSyllables:function(a,b,c){var d,e,f=this;e=f.processSyllable(b),e?(d=f.createAnnot(e.text,f.cfg.lyricsFont).setBottom(!0),e.wordpos&&f.hyphenation.addSyllable(d,e.wordpos,c)):d=f.createAnnot("",f.cfg.lyricsFont).setBottom(!0),a.addAnnotation(2,d)},processSyllable:function(a){var b,d;return b=c(a).find("syl")[0],b?(d=c(b).attr("wordpos"),{text:c(b).text(),wordpos:d}):void 0},createAnnot:function(a,c){return new b.Annotation(a).setFont(c.family,c.size,c.weight)},getMandatoryAttr:function(b,d){var e;if(e=c(b).attr(d),!e)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+d+" is mandatory.");return e},durMap:{breve:"0",1:"w",2:"h",4:"q",8:"8",16:"16",32:"32",64:"64"},translateDuration:function(b){var c,d=this;if(b+="",c=d.durMap[b])return c;throw new a.RUNTIME_ERROR("BadArguments",'The MEI duration "'+b+'" is not supported.')},processAttsDuration:function(a,b){var e,f,g=this;return f=c(a).attr("dur"),f===d&&alert("Could not get duration from:\n"+JSON.stringify(a,null,"	")),e=g.translateDuration(f),b||"1"!==c(a).attr("dots")||(e+="d"),e},setStemDir:function(a,d){var e;e={down:b.StaveNote.STEM_DOWN,up:b.StaveNote.STEM_UP}[c(a).attr("stem.dir")],e?d.stem_direction=e:d.auto_stem=!0},drawVexStaffs:function(a,b){var c,d,e,f;for(c=a.length;c--;)if(a[c]){for(e=0,d=a[c].length;d--;)f=a[c][d],f&&(e=Math.max(e,f.getNoteStartX()));for(d=a[c].length;d--;)f=a[c][d],f&&(f.setNoteStartX(e),f.setContext(b).draw())}},getFirstDefinedStaff:function(b){for(var c=b.length;c--;)if(b[c])return c;
throw new a.RUNTIME_ERROR("ERROR","getFirstDefinedStaff(): no staff found in the current measure.")},drawVexVoices:function(a,b){var c,d,e,f,g=this;for(c=0,d=a.length;d>c;c+=1)e=a[c].measureStaffs,f||(f=g.getFirstDefinedStaff(e)),a[c].staveVoices.format(e[f].getNoteEndX()-e[f].getNoteStartX()-g.cfg.measurePaddingRight),a[c].staveVoices.draw(b,e)},drawVexBeams:function(a,b){c.each(a,function(a,c){c.setContext(b).draw()})},drawAnchoredTexts:function(a,b,d){var e,f,g;c.each(a,function(a,c){g=c.container,f=+c.y||g.getYForLine(3)-4+(+c.vo*b||0),e=+c.x||g.glyph_start_x+(+c.ho*b||0),d.font=c.font||"20px Times",c.align&&(d.textAlign=c.align),d.fillText(c.text,e,f)})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Hairpins=function(){this.init()},a.Hairpins.prototype={init:function(){this.allVexHairpins=[],this.allHairpinInfos=[]},add:function(a){this.allHairpinInfos.push(a)},createVexFromLinks:function(e){var f,g,h,i,j,k,l=this;return j={height:10,y_shift:0,left_shift_px:0,r_shift_px:0},c.each(l.allHairpinInfos,function(c,m){f=e[m.getFirstId()],g=e[m.getLastId()],h=a.tables.positions[m.params.place],i=a.tables.hairpins[m.params.form],k=new b.StaveHairpin({first_note:f?f.vexNote:d,last_note:g?g.vexNote:d},i),k.setRenderOptions(j),k.setPosition(h),l.allVexHairpins.push(k)}),this},setContext:function(a){return this.ctx=a,this},draw:function(){var a=this.ctx;c.each(this.allVexHairpins,function(b,c){c.setContext(a).draw()})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Ties=function(){this.init()},a.Ties.prototype={init:function(){this.allVexTies=[],this.allTieInfos=[]},add:function(a){this.allTieInfos.push(a)},getAll:function(){return this.allTieInfos},start_tieslur:function(b,c){var d=new a.EventLink(b,null);d.setParams({linkCond:c}),this.allTieInfos.push(d)},terminate_tie:function(b,c){var d,e,f,g,h;if(h=this.getAll(),d=function(a,b){return a&&b&&a.pname===b.pname&&a.oct===b.oct&&a.system===b.system},!c.pname||!c.oct)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or octave specified for the tie");for(e=!1,f=0;!e&&f<h.length;++f)g=h[f],g.getLastId()||d(g.params.linkCond,c)&&(e=!0,g.setLastId(b));e||this.add(new a.EventLink(null,b))},terminate_slur:function(b,c){var d,e,f,g,h=this,i=this.getAll();for(d=function(a,b){return a.nesting_level===b.nesting_level&&a.system===b.system},e=!1,f=0;f<i.length;++f)if(g=i[f],g&&!g.getLastId()&&d(g.params.linkCond,c)){g.setLastId(b),e=!0;break}e||h.add(new a.EventLink(null,b))},createVexFromLinks:function(a){{var e,f,g,h,i,j=this;this.ctx}return c.each(j.allTieInfos,function(c,k){e=a[k.getFirstId()],f=a[k.getLastId()],h=k.params.bezier,h?(i=j.bezierStringToCps(h),g=new b.Curve(e?e.vexNote:d,f?f.vexNote:d,{cps:i,y_shift_start:+k.params.startvo,y_shift_end:+k.params.endvo})):(g=new b.StaveTie({first_note:e?e.vexNote:d,last_note:f?f.vexNote:d,first_indices:e?e.index:d,last_indices:f?f.index:d}),g.setDir(k.params.curvedir)),j.allVexTies.push(g)}),this},bezierStringToCps:function(a){for(var b,c=[],d=a.split(" ");d[0];)b=d.splice(0,2),c.push({x:+b[0],y:+b[1]});return c},setContext:function(a){return this.ctx=a,this},draw:function(){var a=this.ctx;c.each(this.allVexTies,function(b,c){c.setContext(a).draw()})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.EventLink=function(a,b){this.init(a,b)},a.EventLink.prototype={init:function(b,c){this.first_ref=new a.EventReference(b),this.last_ref=new a.EventReference(c),this.params={}},setParams:function(a){this.params=a},setFirstRef:function(a){this.first_ref=a},setLastRef:function(a){this.last_ref=a},setFirstId:function(a){this.first_ref.setId(a)},setLastId:function(a){this.last_ref.setId(a)},setFirstTStamp:function(a){this.first_ref.setTStamp(a)},setLastTStamp:function(a){this.last_ref.setTStamp(a)},setContext:function(a){this.meicontext=a},getFirstId:function(){return this.first_ref.getId({meicontext:this.meicontext})},getLastId:function(){return this.last_ref.getId({meicontext:this.meicontext})}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.EventReference=function(a){this.xmlid=a},a.EventReference.prototype={setId:function(a){this.xmlid=a},setTStamp:function(a){this.tstamp=a,this.xmlid&&this.tryResolveReference(!0)},tryResolveReference:function(){var b,c;if(b=this.tstamp,c=this.meicontext,!b)throw new a.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},getId:function(a){return a&&a.meicontext&&this.setContext(a.meicontext),this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(a&&a.strict),this.xmlid):null},setContext:function(a){this.meicontext=a}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.StaffInfo=function(b,c,d,e){var f=this;f.renderWith={clef:c,keysig:d,timesig:e},f.spacing=0,f.staffDefObj=a.attsToObj(b),f.updateMeter(),f.updateStaveLabels(),f.updateSpacing(),f.currentClef=f.convertClef()},a.StaffInfo.prototype={updateMeter:function(){var a=this;a.staffDefObj.hasOwnProperty("meter.count")&&a.staffDefObj.hasOwnProperty("meter.unit")&&(a.meter={count:+a.staffDefObj["meter.count"],unit:+a.staffDefObj["meter.unit"]})},updateStaveLabels:function(){var a,b,c=this;a=c.staffDefObj.label,"string"==typeof a&&(c.label=a),b=c.staffDefObj["label.abbr"],"string"==typeof b&&(c.labelAbbr=b)},updateSpacing:function(){var a=this;return spacing=+a.staffDefObj.spacing,spacing&&(a.spacing=spacing),a.spacing},forceSectionStartInfo:function(){var a=this;a.renderWith.clef=!0,a.renderWith.keysig=!0,a.renderWith.timesig=!0},forceStaveStartInfo:function(){var a=this;a.renderWith.clef=!0,a.renderWith.keysig=!0},showClefCheck:function(){var a=this;return a.renderWith.clef&&"false"!==a.staffDefObj["clef.visible"]?(a.renderWith.clef=!1,!0):void 0},showKeysigCheck:function(){var a=this;return a.renderWith.keysig&&(a.renderWith.keysig=!1,"false"!==a.staffDefObj["key.sig.show"])?!0:void 0},showTimesigCheck:function(){var a=this;return a.renderWith.timesig&&(a.renderWith.timesig=!1,"norm"===a.staffDefObj["meter.rend"]||a.staffDefObj["meter.rend"]===d)?!0:void 0},convertClef:function(){var c,e,f,g,h=this;if(c=h.staffDefObj["clef.shape"],!c)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute clef.shape is mandatory.");if(e=h.staffDefObj["clef.line"],f=h.staffDefObj["clef.dis"],g=h.staffDefObj["clef.dis.place"],"G"===c&&(!e||"2"===e))return"8"===f&&"below"===g&&b.clefProperties.values.octave!=d?"octave":"treble";if("F"===c&&(!e||"4"===e))return"bass";if("C"===c&&"3"===e)return"alto";if("C"===c&&"4"===e)return"tenor";throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+c+'" '+(e?'clef.line="'+e+'"':"")+" ]")},getClef:function(){return this.currentClef},getKeySpec:function(){var b,c,e,f=this;if(f.staffDefObj["key.pname"]!==d){if(b=f.staffDefObj["key.pname"].toUpperCase(),c=f.staffDefObj["key.accid"],c!==d)switch(c){case"s":b+="#";break;case"f":b+="b";break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}return e=f.staffDefObj["key.mode"],e!==d&&(b+="major"===e?"":"m"),b}return"C"},getTimeSig:function(){var a,b,c,e=this;return(a=e.staffDefObj["meter.sym"])?"cut"===a?"C|":"C":(b=e.staffDefObj["meter.count"],c=e.staffDefObj["meter.unit"],b&&c?b+"/"+c:d)},updateRenderWith:function(a){var b,c,d=this;b={clef:!1,keysig:!1,timesig:!1},c=function(b){return d.staffDefObj[b]===a[b]},c("clef.shape")&&c("clef.line")||(b.clef=!0),c("key.pname")&&c("key.accid")&&c("key.mode")||(b.keysig=!0),c("meter.count")&&c("meter.unit")||(b.timesig=!0),d.renderWith=b},updateDef:function(b){var c,d=this;c=a.attsToObj(b),d.updateRenderWith(c),d.staffDefObj=c,d.updateMeter(),d.updateStaveLabels(),d.updateSpacing(),d.currentClef=d.convertClef()}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a){return a.Hyphenation=function(a){var b=this;b.allSyllables=[],b.printSpaceRight=a.printSpaceRight,b.font=a.lyricsFont,b.maxHyphenDistance=a.maxHyphenDistance},a.Hyphenation.prototype={WORDBOUND:null,addSyllable:function(a,b,c){var d=this;d.allSyllables[c]||(d.allSyllables[c]=[]),"i"===b&&d.allSyllables[c].push(d.WORDBOUND),d.allSyllables[c].push(a),"t"===b&&d.allSyllables[c].push(d.WORDBOUND)},addLineBreaks:function(a,b){var c,d,e=this;for(c=1,d=a.length;d>c;c+=1)e.allSyllables[c]||(e.allSyllables[c]=[]),e.allSyllables[c].push(b)},setContext:function(a){return this.ctx=a,this},draw:function(){var a,b,c,d,e,f,g,h,i,j,e,k,l,m=this;for(m.ctx.setFont(m.font.family,m.font.size,m.font.weight),f=m.ctx.measureText("-").width,g=f/2,a=m.allSyllables.length;a--;)if(m.allSyllables[a])for(b=m.allSyllables[a].length;b--;)if(c=m.allSyllables[a][b],d=m.allSyllables[a][b+1],c!==m.WORDBOUND&&d!==m.WORDBOUND&&("number"==typeof c&&d?(h=c,c={y:d.y}):h=c.x+m.ctx.measureText(c.text).width,"number"==typeof d||"undefined"==typeof d?(d={x:m.printSpaceRight,y:c.y},i=(c.y+d.y)/2,j=Math.max(d.x-h,f+1)):(i=(c.y+d.y)/2,j=d.x-h),c&&d&&j>f))for(e=Math.ceil(j/m.maxHyphenDistance),k=j/(e+1),l=h;e--;)l+=k,m.ctx.fillText("-",l-g,i)}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c,d){return a.Texts=function(){var a=this;a.complexTextModels=[],a.defaultFontSize=25,a.lineHeight=1.3},a.Texts.prototype={addComplexText:function(a,b){var c=this;c.resetTempText(),c.htmlToArray(a,{}),c.complexTextModels.push({coords:b,texts:c.textArray})},resetTempText:function(){this.textArray=[[]],this.line_n=0},htmlToArray:function(b,e){var f,g,h,i,j=this;c(b).contents().each(function(b,k){if("#text"===k.nodeName)i=k.textContent.replace(/([\n|\r]+\s*)/g,""),i&&j.textArray[j.line_n].push({text:i,opts:e});else switch(k.localName){case d:break;case"lb":j.breakLine();break;case"title":g=a.attsToObj(k),h={el:k.localName,halign:"center",fontsize:"sub"===g.type?35:50,fontweight:"Bold"},f=c.extend({},e,h,g),j.htmlToArray(k,f),j.breakLine();break;default:f=c.extend({},e,a.attsToObj(k)),j.htmlToArray(k,f)}})},breakLine:function(){var a=this;a.line_n+=1,a.textArray[a.line_n]=[]},setContext:function(a){return this.ctx=a,this},draw:function(){var a,b,d,e,f,g,h=this;for(g=h.complexTextModels.length;g--;)a=h.complexTextModels[g].coords,c.each(h.complexTextModels[g].texts,function(g,i){b=[],d=[],e=[],f=0,c.each(i,function(a,c){switch(c.opts.halign){case"center":d.push(c);break;case"right":e.push(c);break;default:b.push(c)}}),f=Math.max(h.drawCenterTexts(d,a),h.drawRightAlignedTexts(e,a),h.drawLeftAlignedTexts(b,a)),a.y+=f*h.lineHeight})},drawCenterTexts:function(a,b){var d,e,f,g,h=this,i=0;return c.each(a,function(a,b){d=b.opts.fontsize||h.defaultFontSize,f=b.opts.fontweight||"",g=b.opts.fontstyle||"",h.ctx.font=g+" "+f+" "+d+"px Times",i+=h.ctx.measureText(b.text).width}),e=h.drawLeftAlignedTexts(a,{x:b.x+b.w/2-i/2,y:b.y,w:b.w},h.ctx)},drawLeftAlignedTexts:function(a,b){var d,e,f,g=this,h=0,i=0;return c.each(a,function(a,c){d=c.opts.fontsize||g.defaultFontSize,h=Math.max(d,h),e=c.opts.fontweight||"",f=c.opts.fontstyle||"",g.ctx.font=f+" "+e+" "+d+"px Times",g.ctx.textAlign="left",g.ctx.fillText(c.text,b.x+i,b.y),i+=g.ctx.measureText(c.text).width}),h},drawRightAlignedTexts:function(a,b){var c,d,e,f,g,h=this,i=0,j=0;for(g=a.length;g--;)f=a[g],c=f.opts.fontsize||h.defaultFontSize,i=Math.max(c,i),d=f.opts.fontweight||"",e=f.opts.fontstyle||"",h.ctx.font=e+" "+d+" "+c+"px Times",h.ctx.textAlign="right",h.ctx.fillText(f.text,b.x+b.w-j,b.y),j+=h.ctx.measureText(f.text).width;return i}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c){return a.Connectors=function(a){this.labelScheme=a,this.allVexConnectors=[],this.currentModels={}},a.Connectors.prototype={vexTypes:{line:b.StaveConnector.type.SINGLE_LEFT,brace:b.StaveConnector.type.BRACE,bracket:b.StaveConnector.type.BRACKET,none:null,singleright:b.StaveConnector.type.SINGLE_RIGHT},vexTypesBarlineRight:{single:b.StaveConnector.type.SINGLE_RIGHT,dbl:b.StaveConnector.type.THIN_DOUBLE,end:b.StaveConnector.type.BOLD_DOUBLE_RIGHT,rptend:b.StaveConnector.type.BOLD_DOUBLE_RIGHT,invis:null},vexTypesBarlineLeft:{single:b.StaveConnector.type.SINGLE_LEFT,dbl:b.StaveConnector.type.THIN_DOUBLE,end:b.StaveConnector.type.BOLD_DOUBLE_LEFT,rptstart:b.StaveConnector.type.BOLD_DOUBLE_LEFT,invis:null},addToVexConnectors:function(a){this.allVexConnectors.push(a)},getAll:function(){return this.allVexConnectors},setModelForStaveRange:function(a,b){b=b||"",this.currentModels[a.top_staff_n+":"+a.bottom_staff_n+b]=a},createVexFromModels:function(a,d,e,f){var g,h,i,j,k,l,m=this;l=m.labelScheme,c.each(m.currentModels,function(c,n){g=e?m.vexTypesBarlineRight[e]:m.vexTypes[n.symbol],h=a[n.top_staff_n],i=a[n.bottom_staff_n],"number"==typeof g&&h&&i&&(j=new b.StaveConnector(h,i),j.setType(g),m.addToVexConnectors(j),1===l?k=1===f?n.label:n.labelAbbr:2===l&&(k=n.labelAbbr),k&&j.setText(k)),d&&(g=m.vexTypesBarlineLeft[d],"number"==typeof g&&h&&i&&(j=new b.StaveConnector(h,i),j.setType(g),g===b.StaveConnector.type.BOLD_DOUBLE_LEFT&&(j.checkShift=!0),m.addToVexConnectors(j)))})},setContext:function(a){return this.ctx=a,this},draw:function(){var a,b,c,d;for(a=0,b=this.allVexConnectors.length;b>a;a+=1)c=this.allVexConnectors[a],c.checkShift&&(d=c.top_stave.getModifierXShift(),d>0&&c.setXShift(d)),c.setContext(this.ctx).draw()}},a}(MEI2VF||{},Vex.Flow,jQuery),MEI2VF=function(a,b,c){return a.StaffVoice=function(a,b){this.voice=a,this.staff_n=b},a.StaveVoices=function(){this.all_voices=[]},a.StaveVoices.prototype={addStaffVoice:function(a){this.all_voices.push(a)},addVoice:function(b,c){this.addStaffVoice(new a.StaffVoice(b,c))},reset:function(){this.all_voices=[]},format:function(a){var d=c.map(this.all_voices,function(a){return a.voice});(new b.Formatter).joinVoices(d).format(d,a)},draw:function(a,b){var c,d,e=this.all_voices;for(c=0;c<e.length;++c)d=e[c],d.voice.draw(a,b[d.staff_n])}},a}(MEI2VF||{},Vex.Flow,jQuery);Vex.Flow.durationToTicks.durations[0]||(Vex.Flow.durationToTicks.durations[0]=Vex.Flow.RESOLUTION/.5),Vex.Flow.durationToGlyph.duration_codes[0]||(Vex.Flow.durationToGlyph.duration_codes[0]={common:{head_width:16,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"v1d"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"v5c",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}}),Vex.Flow.clefProperties.values.octave={line_shift:0},Vex.Flow.Clef.types.octave={code:"v83",point:40,line:3},Vex.Flow.ModifierContext.prototype.formatAnnotations=function(){var a=this.modifiers.annotations;if(!a||0===a.length)return this;for(var b,c=this.state.text_line,d=0,e=0;e<a.length;++e){var f=a[e];f.setTextLine(c),b=f.getWidth()>d?f.getWidth():d}return this.state.left_shift+=b/2,this.state.right_shift+=b/2,this},Vex.Flow.Curve.prototype.renderCurve=function(a){var b=this.context,c=this.render_options.cps,d=this.render_options.x_shift,e=this.render_options.y_shift*a.direction,f=this.render_options.y_shift_start||0,g=this.render_options.y_shift_end||0,h=a.first_x+d,i=a.first_y+e+f,j=a.last_x-d,k=a.last_y+e+g,l=this.render_options.thickness,m=(j-h)/(c.length+2);b.beginPath(),b.moveTo(h,i),b.bezierCurveTo(h+m+c[0].x,i+c[0].y*a.direction,j-m+c[1].x,k+c[1].y*a.direction,j,k),b.bezierCurveTo(j-m+c[1].x,k+(c[1].y+l)*a.direction,h+m+c[0].x,i+(c[0].y+l)*a.direction,h,i),b.stroke(),b.closePath(),b.fill()},Vex.Flow.Barline=function(){function a(a,b){arguments.length>0&&this.init(a,b)}a.type={SINGLE:1,DOUBLE:2,END:3,REPEAT_BEGIN:4,REPEAT_END:5,REPEAT_BOTH:6,NONE:7};var b=Vex.Flow.STAVE_LINE_THICKNESS;return Vex.Inherit(a,Vex.Flow.StaveModifier,{init:function(b,c){a.superclass.init.call(this),this.barline=b,this.x=c},getCategory:function(){return"barlines"},setX:function(a){return this.x=a,this},draw:function(b,c){switch(c="number"!=typeof c?0:c,this.barline){case a.type.SINGLE:this.drawVerticalBar(b,this.x,!1);break;case a.type.DOUBLE:this.drawVerticalBar(b,this.x,!0);break;case a.type.END:this.drawVerticalEndBar(b,this.x);break;case a.type.REPEAT_BEGIN:c>0&&this.drawVerticalBar(b,this.x),this.drawRepeatBar(b,this.x+c,!0);break;case a.type.REPEAT_END:this.drawRepeatBar(b,this.x,!1);break;case a.type.REPEAT_BOTH:this.drawRepeatBar(b,this.x,!1),this.drawRepeatBar(b,this.x,!0)}},drawVerticalBar:function(a,c,d){if(!a.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var e=a.getYForLine(0),f=a.getYForLine(a.options.num_lines-1)+b/2-1;d&&a.context.fillRect(c-3,e,1,f-e+1),a.context.fillRect(c,e,1,f-e+1)},drawVerticalEndBar:function(a,c){if(!a.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var d=a.getYForLine(0),e=a.getYForLine(a.options.num_lines-1)+b/2-1;a.context.fillRect(c-5,d,1,e-d+1),a.context.fillRect(c-2,d,3,e-d+1)},drawRepeatBar:function(a,c,d){if(!a.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var e=a.getYForLine(0),f=a.getYForLine(a.options.num_lines-1)+b/2-1,g=3;d||(g=-5),a.context.fillRect(c+g,e,1,f-e+1),a.context.fillRect(c-2,e,3,f-e+1);var h=2;d?g+=4:g-=4;var i=c+g+h/2,j=(a.options.num_lines-1)*a.options.spacing_between_lines_px;j=j/2-a.options.spacing_between_lines_px/2;var k=e+j+h/2;a.context.beginPath(),a.context.arc(i,k,h,0,2*Math.PI,!1),a.context.fill(),k+=a.options.spacing_between_lines_px,a.context.beginPath(),a.context.arc(i,k,h,0,2*Math.PI,!1),a.context.fill()}}),a}(),Vex.Flow.Annotation=function(){function a(a){arguments.length>0&&this.init(a)}a.Justify={LEFT:1,CENTER:2,RIGHT:3,CENTER_STEM:4},a.VerticalJustify={TOP:1,CENTER:2,BOTTOM:3,CENTER_STEM:4};var b=Vex.Flow.Modifier;return Vex.Inherit(a,b,{init:function(b){a.superclass.init.call(this),this.note=null,this.index=null,this.text_line=0,this.text=b,this.justification=a.Justify.CENTER,this.vert_justification=a.VerticalJustify.TOP,this.font={family:"Arial",size:10,weight:""},this.setWidth(Vex.Flow.textWidth(b))},getCategory:function(){return"annotations"},setTextLine:function(a){return this.text_line=a,this},setFont:function(a,b,c){return this.font={family:a,size:b,weight:c},this},setBottom:function(b){return this.vert_justification=b?a.VerticalJustify.BOTTOM:a.VerticalJustify.TOP,this},setVerticalJustification:function(a){return this.vert_justification=a,this},getJustification:function(){return this.justification},setJustification:function(a){return this.justification=a,this},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw text annotation without a context.");if(!this.note)throw new Vex.RERR("NoNoteForAnnotation","Can't draw text annotation without an attached note.");var c=this.note.getModifierStartXY(b.Position.ABOVE,this.index);this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.weight);var d,e,f=this.context.measureText(this.text).width,g=this.context.measureText("m").width;d=this.justification==a.Justify.LEFT?c.x:this.justification==a.Justify.RIGHT?c.x-f:this.justification==a.Justify.CENTER?c.x-f/2:this.note.getStemX()-f/2;var h,i,j=!this.note.hasStem(),k=!j;if(k&&(h=this.note.getStemExtents(),i=this.note.getStave().options.spacing_between_lines_px),this.vert_justification==a.VerticalJustify.BOTTOM){if(e=this.note.stave.getYForBottomText(this.text_line),k){var l=1===this.note.stem_direction?h.baseY:h.topY;e=Vex.Max(e,l+i*(this.text_line+2))}}else if(this.vert_justification==a.VerticalJustify.CENTER){var m=this.note.getYForTopText(this.text_line)-1,n=this.note.stave.getYForBottomText(this.text_line);e=m+(n-m)/2+g/2}else if(this.vert_justification==a.VerticalJustify.TOP)e=Vex.Min(this.note.stave.getYForTopText(this.text_line),this.note.ys[0]-10),k&&(e=Vex.Min(e,h.topY-5-i*this.text_line));else{var o=this.note.getStemExtents();e=o.topY+(o.baseY-o.topY)/2+g/2}this.x=d,this.y=e,this.context.fillText(this.text,d,e),this.context.restore()}}),a}(),Vex.Flow.StaveTie=function(){function a(a,b){arguments.length>0&&this.init(a,b)}return a.prototype={init:function(a,b){this.notes=a,this.context=null,this.text=b,this.render_options={cp1:8,cp2:12,text_shift_x:0,first_x_shift:0,last_x_shift:0,y_shift:7,tie_spacing:0,font:{family:"Arial",size:10,style:""}},this.font=this.render_options.font,this.setNotes(a)},setContext:function(a){return this.context=a,this},setFont:function(a){return this.font=a,this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Tie needs to have either first_note or last_note set.");if(a.first_indices||(a.first_indices=[0]),a.last_indices||(a.last_indices=[0]),a.first_indices.length!=a.last_indices.length)throw new Vex.RuntimeError("BadArguments","Tied notes must have similar index sizes");return this.first_note=a.first_note,this.first_indices=a.first_indices,this.last_note=a.last_note,this.last_indices=a.last_indices,this},isPartial:function(){return!this.first_note||!this.last_note},setDir:function(a){this.curvedir=a},renderTie:function(a){if(0===a.first_ys.length||0===a.last_ys.length)throw new Vex.RERR("BadArguments","No Y-values to render");this.curvedir&&(a.direction="above"===this.curvedir?-1:1);var b=this.context,c=this.render_options.cp1,d=this.render_options.cp2;Math.abs(a.last_x_px-a.first_x_px)<10&&(c=2,d=8);for(var e=this.render_options.first_x_shift,f=this.render_options.last_x_shift,g=this.render_options.y_shift*a.direction,h=0;h<this.first_indices.length;++h){var i=(a.last_x_px+f+(a.first_x_px+e))/2,j=a.first_ys[this.first_indices[h]]+g,k=a.last_ys[this.last_indices[h]]+g;if(isNaN(j)||isNaN(k))throw new Vex.RERR("BadArguments","Bad indices for tie rendering.");var l=(j+k)/2+c*a.direction,m=(j+k)/2+d*a.direction;b.beginPath(),b.moveTo(a.first_x_px+e,j),b.quadraticCurveTo(i,l,a.last_x_px+f,k),b.quadraticCurveTo(i,m,a.first_x_px+e,j),b.closePath(),b.fill()}},renderText:function(a,b){if(this.text){var c=(a+b)/2;c-=this.context.measureText(this.text).width/2,this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.style),this.context.fillText(this.text,c+this.render_options.text_shift_x,(this.first_note||this.last_note).getStave().getYForTopText()-1),this.context.restore()}},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var a,b,c,d,e,f=this.first_note,g=this.last_note;return f?(a=f.getTieRightX()+this.render_options.tie_spacing,e=f.getStemDirection(),c=f.getYs()):(a=g.getStave().getTieStartX(),c=g.getYs(),this.first_indices=this.last_indices),g?(b=g.getTieLeftX()+this.render_options.tie_spacing,e=g.getStemDirection(),d=g.getYs()):(b=f.getStave().getTieEndX(),d=f.getYs(),this.last_indices=this.first_indices),this.renderTie({first_x_px:a,last_x_px:b,first_ys:c,last_ys:d,direction:e}),this.renderText(a,b),!0}},a}();var MEI2VF=function(a,b,c,d){return a.CONST={LABELS_NONE:0,LABELS_FULL:1,LABELS_ABBR:2},a.RUNTIME_ERROR=function(a,b){this.error_code=a,this.message=b},a.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message},a.attsToObj=function(a){var b,c;if(a.attributes)for(c={},b=a.attributes.length;b--;)c[a.attributes[b].nodeName]=a.attributes[b].nodeValue;return c},a.listAttrs=function(a){var b,c,d,e,f="";for(d=a.attributes,b=0,c=d.length;c>b;b+=1)e=d.item(b),f+=" "+e.nodeName+'="'+e.nodeValue+'"';return f},a.render_notation=function(b,d,e,f,g,h){{var i=c.extend(!0,{},{page_height:f,page_width:e,xmlDoc:b,target:d,backend:g},h);new a.Viewer(i)}},a.getRenderedMeasures=function(){return a.rendered_measures},a.defaults={page_scale:1,page_height:350,page_width:800,page_margin_top:60,page_margin_left:20,page_margin_right:20,systemLeftMar:0,systemSpacing:100,staveSpacing:60,measurePaddingRight:10,autoStaveConnectorLine:!0,autoMeasureNumbers:!1,labelScheme:a.CONST.LABELS_NONE,maxHyphenDistance:75,lyricsFont:{family:"Times",size:15},annotFont:{family:"Times",size:15,weight:"Italic"},staffFont:{family:"Times",size:14,weight:"Italic"},tempoFont:{family:"Times",size:17,weight:"bold"},staff:{vertical_bar_width:20,fill_style:"#000000",spacing_between_lines_px:10,top_text_position:1.5,bottom_text_position:7.5}},a.Viewer=function(a){this.init(a)},a.Viewer.prototype={init:function(d){var e=this;if(!d)throw new a.RUNTIME_ERROR("MEI2VF.RERR.NoConfig","No config passed to Renderer.");if(!d.xmlDoc)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingData","No XML document passed to Renderer.");d.xmlDoc=e.initXmlDoc(d.xmlDoc);var f=c(d.xmlDoc).find("scoreDef")[0];if(!f)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found in config.data.");var g=c.extend(!0,{},a.defaults,e.getMEIPageConfig(f),d),h=e.createCanvas(g.target,g.backend,g),i=e.createContext(h,g.backend);g.page_margin_top-=40,g.printSpaceRight=g.page_width-g.page_margin_right,g.printSpaceWidth=Math.floor(g.printSpaceRight-g.page_margin_left)-1,b.STAVE_LINE_THICKNESS=1,+g.backend===b.Renderer.Backends.RAPHAEL?e.scaleContextRaphael(h,i,g.page_scale):e.scaleContext(i,g.page_scale),g.ctx=i,e.renderer=new a.Renderer,e.renderer.initConfig(g),e.renderer.process(),e.renderer.draw(),a.rendered_measures=e.renderer.allVexMeasureStaffs},initXmlDoc:function(a){return"string"==typeof a&&(a=c.parseXML(a)),a[0]||a},getMEIPageConfig:function(b){var c=a.attsToObj(b);return{page_scale:parseInt(c["page.scale"],10)/100||d,page_height:c["page.height"],page_width:c["page.width"],page_margin_top:isNaN(+c["page.topmar"])?d:+c["page.topmar"],page_margin_left:isNaN(+c["page.leftmar"])?d:+c["page.leftmar"],page_margin_right:isNaN(+c["page.rightmar"])?d:+c["page.rightmar"]}},createXMLDoc:function(a){var b,c;return a=this.removeNS(a),window.DOMParser?(c=new DOMParser,b=c.parseFromString(txt,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(txt)),XmlDoc},removeNS:function(a){return a.replace(/(<[\/]?)[\w]+:/g,"$1")},createCanvas:function(a,d,e){var f,g;return f=e.page_height,g=e.page_width,"canvas"===a.localName||"svg"===a.localName?a:+d===b.Renderer.Backends.RAPHAEL?c('<svg width="'+g+'" height="'+f+'"></svg>').appendTo(a).get(0):(g*=e.page_scale,f*=e.page_scale,c('<canvas width="'+g+'" height="'+f+'"></canvas>').appendTo(a).get(0))},createContext:function(a,c){return new b.Renderer(a,c||b.Renderer.Backends.CANVAS).getContext()},scaleContext:function(a,b){a.scale(b,b)},scaleContextRaphael:function(){}},a.util={drawBoundingBoxes:function(a,b){var d,e,f,g,h,i,j,k=this;if(b=b||{},a.save(),b.staffs&&b.staffs.data)for(d=0,e=b.staffs.data.length;e>d;d+=1)if(h=b.staffs.data[d])for(f=0,g=h.length;g>f;f+=1)h[f]&&(i=h[f],h[f].getBoundingBox().draw(a),j={x:i.getNoteStartX(),y:i.getYForLine(0)-30,w:i.getNoteEndX()-i.getNoteStartX(),h:i.getYForLine(4)-i.getYForLine(0)+60},k.drawRectangle(j,"120, 80, 200",a,b.frame),j={x:i.x,y:i.getYForLine(0)-30,w:i.getModifierXShift(),h:i.getYForLine(4)-i.getYForLine(0)+60},k.drawRectangle(j,"100, 100, 0",a,b.frame));b.voices&&b.voices.data&&c.each(b.voices.data,function(d,e){e&&e.staveVoices&&e.staveVoices.all_voices&&c.each(e.staveVoices.all_voices,function(d,e){e&&e.voice&&(e.voice.boundingBox&&b.voices.drawFrame&&e.voice.getBoundingBox().draw(a),b.voices.drawTickables&&c.each(e.voice.tickables,function(b,c){c.getBoundingBox().draw(a)}))})}),a.restore()},drawRectangle:function(a,b,c,d){d&&(c.strokeStyle="rgba("+b+", 0.5)",c.rect(a.x,a.y,a.w,a.h)),c.fillStyle="rgba("+b+", 0.1)",c.fillRect(a.x,a.y,a.w,a.h),c.stroke()}},{render_notation:a.render_notation,getRenderedMeasures:a.getRenderedMeasures,Renderer:a.Renderer,Viewer:a.Viewer,CONST:a.CONST,defaults:a.defaults}}(MEI2VF||{},Vex.Flow,jQuery);